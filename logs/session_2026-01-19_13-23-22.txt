[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üî¥ CODE SUPPRIM√â :
   - # A. Trouver la colonne population
   - db_cols = [c[0].upper() for c in con.execute("DESCRIBE territoires").fetchall()]
   - # NOUVEAU : Liste de candidats probables pour la population
   - pop_candidates = ["PMUN", "PTOT", "POP", "P21_POP", "P20_POP", "P19_POP", "PMUN21", "PMUN20"]
   - pop_col = None
   - 
   - # 1. Recherche exacte
   - for cand in pop_candidates:
   - if cand in db_cols:
   - pop_col = cand
   - break
   - 
   - # 2. Recherche partielle (contient "POP" ou "PMUN")
   - if not pop_col:
   - pop_col = next((c for c in db_cols if "PMUN" in c or ("POP" in c and "TOT" in c)), None)
   - 
   - if pop_col:
   - ids_sql_list = ", ".join([f"'{i}'" for i in comparators])
   - 
   - # B. Requ√™te Robuste (inchang√©e)
   - q_sort = f"""
   - SELECT ID
   - FROM territoires
   - WHERE ID IN ({ids_sql_list})
   - ORDER BY TRY_CAST(REPLACE(CAST("{pop_col}" AS VARCHAR), ' ', '') AS INTEGER) ASC
   - """
   - sorted_comparators = [str(x[0]) for x in con.execute(q_sort).fetchall()]
   - _dbg("plot.sort", status="success", col=pop_col, order=sorted_comparators)
   - _dbg("plot.sort", status="failed", reason=f"Colonne pop introuvable parmi {db_cols[:10]}...")
üü¢ CODE AJOUT√â :
   + # 2. TRI VISUEL (TAILLE / POPULATION VIA TABLE 'EVO')
   + final_display_order = []
   + 
   + # S√©paration : Cible (toujours en 1er) vs Comparateurs (√† trier)
   + # A. Identifier la table EVO disponible
   + # On r√©cup√®re la liste des tables valides stock√©e en session
   + valid_tables = st.session_state.get("valid_tables_list", [])
   + # On cherche une table qui contient "EVO" (ex: EVO, EVO_10, EVO_5)
   + evo_table = next((t for t in valid_tables if "EVO" in t), None)
   + if evo_table:
   + # B. Trouver la colonne population la plus r√©cente (ex: P21_POP)
   + evo_cols = [c[0].upper() for c in con.execute(f"DESCRIBE \"{evo_table}\"").fetchall()]
   + 
   + # On cherche les colonnes qui ressemblent √† Pxx_POP ou Pxx_PMUN
   + # Ex: P21_POP, P19_POP...
   + pop_candidates = [c for c in evo_cols if "POP" in c and any(char.isdigit() for char in c)]
   + 
   + # On prend la derni√®re par ordre alphab√©tique (souvent l'ann√©e la plus r√©cente P21 > P19)
   + pop_col = sorted(pop_candidates)[-1] if pop_candidates else None
   + 
   + # Fallback si pas de Pxx_POP : on cherche juste 'POP' ou 'PMUN'
   + if not pop_col:
   + pop_col = next((c for c in evo_cols if c in ["POP", "PMUN", "PTOT", "POPULATION"]), None)
   + 
   + if pop_col:
   + ids_sql_list = ", ".join([f"'{i}'" for i in comparators])
   + 
   + # C. Requ√™te de tri sur la table EVO
   + # Pas besoin de REPLACE/CAST car EVO est d√©j√† num√©rique normalement
   + q_sort = f"""
   + SELECT t.ID
   + FROM territoires t
   + LEFT JOIN "{evo_table}" e ON t.ID = e.ID
   + WHERE t.ID IN ({ids_sql_list})
   + ORDER BY TRY_CAST(e."{pop_col}" AS DOUBLE) ASC
   + """
   + sorted_comparators = [str(x[0]) for x in con.execute(q_sort).fetchall()]
   + _dbg("plot.sort", status="success", table=evo_table, col=pop_col, order=sorted_comparators)
   + else:
   + _dbg("plot.sort", status="failed", reason=f"Colonne POP introuvable dans {evo_table}")
   + _dbg("plot.sort", status="failed", reason="Table EVO introuvable")
========================================

[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üìã Tables valides enregistr√©es : 75
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process="Quel est le taux de ch√¥mage des jeunes √† Saint Michel dans l'Aisne, compar√© √† Vincennes, Cergy et Lille ?" from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail="assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Quel est le taux de ch√¥mage des jeunes √† Saint Michel dans l'Aisne, compar√© √† Vincennes, Cergy et Lille ?" current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le taux de ch√¥mage des jeunes √† Saint-Michel (d√©partement de l‚ÄôAisne), et comment se compare-t-il √† celui de Vincennes, Cergy et Lille ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Michel (Aisne)' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '9271', 'NOM_COUV': 'Saint-Michel', 'COMP1': '200066231', 'COMP2': 'D9', 'COMP3': 'R76', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.8933333333333334}, {'ID': '32397', 'NOM_COUV': 'Saint-Michel',
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Michel (Aisne)' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "2684",\n  "reason": "Le terme recherch√© est ¬´ Saint-Michel (Aisne) ¬ª : l‚ÄôAisne correspond au d√©partement 02 (COMP2 = D2). Parmi les candidats ¬´ Saint-Michel ¬ª, seule la commune a
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est uniquement le nom de ville ¬´ Vincennes ¬ª (sans mention d‚Äôintercommunalit√©) : on s√©lectionne donc la commune. Parmi les candidats, ¬´ V
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Cergy' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '95127', 'NOM_COUV': 'Cergy', 'COMP1': '249500109', 'COMP2': 'D95', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '91129', 'NOM_COUV': 'Cerny', 'COMP1': '249100546', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Cergy' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "95127",\n  "reason": "Le terme recherch√© est simplement ¬´ Cergy ¬ª dans une comparaison de villes ; selon la r√®gle, on s√©lectionne la commune. Parmi les candidats, ¬´ Cergy ¬ª corre
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Lille' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '59350', 'NOM_COUV': 'Lille', 'COMP1': '200093201', 'COMP2': 'D59', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '62516', 'NOM_COUV': 'Lillers', 'COMP1': '200072460', 'C
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Lille' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "59350",\n  "reason": "Le terme recherch√© est uniquement ¬´ Lille ¬ª (sans mention d‚Äôagglo/m√©tropole/interco) : selon la r√®gle, on s√©lectionne la commune. Parmi les candidats, ¬´ Lil
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Saint-Michel', 'target_id': '2684', 'all_ids': ['2684', '240200600', 'D2', 'R32', '94080', '95127', '59350', 'FR'], 'parent_clause': '', 'display_context': 'Saint-Michel (Aisne), Vinc
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Saint-Michel', 'target_id': '2684', 'all_ids': ['2684', '240200600', 'D2', 'R32', '94080', '95127', '59350', 'FR'], 'parent_clause': '', 'display_context': 'Saint-Michel (Aisne), Vinc
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quel est le taux de ch√¥mage des jeunes √† Saint-Michel (d√©partement de l‚ÄôAisne), et comment se compare-t-il √† celui de Vincennes, Cergy et Lille ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quel est le taux de ch√¥mage des jeunes √† Saint-Michel (d√©partement de l‚ÄôAisne), et comment se compare-t-il √† celui de Vincennes, Cergy et Lille ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quel est le taux de ch√¥mage des jeunes √† Saint-Michel (d√©partement de l‚ÄôAisne), et comment se compare-t-il √† celui de Vi' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.46821029878920206
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=563
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7161
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7161 preview='‚úÖ TABLE: "ACT_10" | VAR: "p11_hchom1524" | DESC: "Hommes actifs au ch√¥mage de 15-24 ans en 2011"\n‚úÖ TABLE: "EMPL" | VAR: "1524_STAG" | DESC: "Population des 15-24 ans stagiaires r√©mun√©r√©s en entrepri
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=8 parent_clause='' sys_prompt_len=10425
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1524" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_act1524" AS DOUBLE), 0) AS "taux_chomage_jeunes_15_24_2022"\nFROM territoires t\nLEFT JOIN "ACT" a 
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1524" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_act1524" AS DOUBLE), 0) AS "taux_chomage_15_24_2022"\nFROM territoires t\nLEFT JOIN "ACT" a ON t."I ids=['2684', '240200600', 'D2', 'R32', '94080', '95127', '59350', 'FR'] ids_count=8
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=8 cols=['ID', 'NOM_COUV', 'taux_chomage_15_24_2022']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D2', 'NOM_COUV': 'Aisne', 'taux_chomage_15_24_2022': 0.324123893261024}, {'ID': 'R32', 'NOM_COUV': 'Hauts-de-France', 'taux_chomage_15_24_2022': 0.2866802704316237}, {'ID': 'FR', 'NOM_COUV': 
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quel est le taux de ch√¥mage des jeunes √† Saint-Michel (d√©partement de l‚ÄôAisne), et comment se compare-t-il √† celui de Vincennes, Cergy et Lille ?' df_rows=8 df_cols=3
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['taux_chomage_15_24_2022']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='N" | VAR: "defm2018" | DESC: "Nombre de DEFM en 2018"\n‚úÖ TABLE: "DEFM_AN" | VAR: "defm2019" | DESC: "Nombre de DEFM en 2019"\n‚úÖ TABLE: "ACT_5" | VAR: "p16_h2554" | DESC: "Hommes de 25 √† 54 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['taux_chomage_15_24_2022'] formats_keys=['taux_chomage_15_24_2022']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['taux_chomage_15_24_2022'] formats={'taux_chomage_15_24_2022': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage 15-24', 'title': 'Taux de ch√¥mage des 15-24 ans (2022)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=8 df_cols=['ID', 'NOM_COUV', 'taux_chomage_15_24_2022'] sorted_ids=['2684', '240200600', 'D2', 'R32', '94080', '95127', '59350', 'FR'] selected_metrics=['taux_chomage_15_24_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' table='EVO' col='POP_MOCO_40' order=['94080', '240200600', 'D2', 'R32']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=8 df_cols=['ID', 'NOM_COUV', 'taux_chomage_15_24_2022'] formats={'taux_chomage_15_24_2022': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage 15-24', 'title': 'Taux de ch√¥mage des 15-24 ans (2022)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1395
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=8 df_cols=['ID', 'NOM_COUV', 'taux_chomage_15_24_2022'] sorted_ids=['2684', '240200600', 'D2', 'R32', '94080', '95127', '59350', 'FR'] selected_metrics=['taux_chomage_15_24_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' table='EVO' col='POP_MOCO_40' order=['94080', '240200600', 'D2', 'R32']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Compare Vincennes avec des villes voisines' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=3
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='bilit√©, partenariats avec les employeurs, ciblage des ‚ÄúNEET‚Äù, etc.).\n\n**Pour aller plus loin :** souhaitez-vous un graphique qui compare **le ch√¥mage des 15‚Äì24 ans** entre les communes/intercommuna current_geo_name='Saint-Michel'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Pouvez-vous **comparer le taux de ch√¥mage des jeunes (15‚Äì24 ans) √† Vincennes** avec celui des **communes voisines de Vincennes** (par exemple **Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-l
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Saint-Michel'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est uniquement le nom de la ville ¬´ Vincennes ¬ª (sans mention d‚Äôagglo/m√©tropole/intercommunalit√©) : selon la r√®gle 1, on s√©lectionne la c
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Mand√©' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '22312', 'NOM_COUV': 'Saint-Maden', 'COMP1': '200068989', 'COMP2': 'D22', 'COMP3': 'R53', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9436363636363637}, {'ID': '33436', 'NOM_COUV': 'Saint-Magne',
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Mand√©' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94067",\n  "reason": "Le terme recherch√© est un nom de ville (¬´ Saint-Mand√© ¬ª) dans le contexte des communes voisines de Vincennes ; on s√©lectionne donc la commune. Parmi les can
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Montreuil' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '28267', 'NOM_COUV': 'Montreuil', 'COMP1': '200040277', 'COMP2': 'D28', 'COMP3': 'R24', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '85148', 'NOM_COUV': 'Montreuil', 'COMP1': '20007193
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Montreuil' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "93048",\n  "reason": "Dans le contexte (Vincennes et ses communes voisines en Val-de-Marne/Seine-Saint-Denis), ¬´ Montreuil ¬ª d√©signe la commune limitrophe de Vincennes situ√©e en 
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Fontenay-sous-Bois' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '94033', 'NOM_COUV': 'Fontenay-sous-Bois', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9555555555555556}, {'ID': '76275', 'NOM_COUV': 'Fonten
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Fontenay-sous-Bois' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94033",\n  "reason": "Le terme recherch√© est un nom de ville pr√©cis (¬´ Fontenay-sous-Bois ¬ª) cit√© comme commune voisine de Vincennes ; selon la r√®gle, on s√©lectionne la Commune. 
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Charenton-le-Pont' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=6 sample=[{'ID': 'D16', 'NOM_COUV': 'Charente', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.0441176470588236}, {'ID': '94018', 'NOM_COUV': 'Charenton-le-Pont', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Charenton-le-Pont' candidates_len=6
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94018",\n  "reason": "Le terme recherch√© est un nom de ville (¬´ Charenton-le-Pont ¬ª) sans mention d‚Äôintercommunalit√© ; selon la r√®gle, on s√©lectionne la commune. Parmi les candid
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Maurice' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '58257', 'NOM_COUV': 'Saint-Maurice', 'COMP1': '200067908', 'COMP2': 'D58', 'COMP3': 'R27', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9692307692307692}, {'ID': '67427', 'NOM_COUV': 'Saint-Mauri
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Maurice' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94069",\n  "reason": "Dans le contexte, il s‚Äôagit des communes voisines de Vincennes (Val-de-Marne, D94). ¬´ Saint-Maurice ¬ª correspond donc √† la commune INSEE 94069 (et non aux h
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', '94069', 'FR'], 'parent_clause': '', 'display_context': 'Vincenne
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', '94069', 'FR'], 'parent_clause': '', 'display_context': 'Vincenne
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Pouvez-vous **comparer le taux de ch√¥mage des jeunes (15‚Äì24 ans) √† Vincennes** avec celui des **communes voisines de Vincennes** (par exemple **Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-l df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Pouvez-vous **comparer le taux de ch√¥mage des jeunes (15‚Äì24 ans) √† Vincennes** avec celui des **communes voisines de Vincennes** (par exemple **Saint-Mand√©, Mon' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Pouvez-vous **comparer le taux de ch√¥mage des jeunes (15‚Äì24 ans) √† Vincennes** avec celui des **communes voisines de Vin' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5572032797462982
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1323
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7066
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7066 preview='‚úÖ TABLE: "ACT_10" | VAR: "p11_pop1524" | DESC: "Population de 15-24 ans en 2011"\n‚úÖ TABLE: "ACT_10" | VAR: "p11_pop2554" | DESC: "Population de 25-54 ans en 2011"\n‚úÖ TABLE: "ACT" | VAR: "p22_poptot15
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=10 parent_clause='' sys_prompt_len=10510
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1524" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_act1524" AS DOUBLE), 0) AS "taux_chomage_1524_2022"\nFROM territoires t\nLEFT JOIN "ACT" a\n  ON t.
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1524" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_act1524" AS DOUBLE), 0) AS "taux_chomage_1524_2022"\nFROM territoires t\nLEFT JOIN "ACT" a\n  ON t. ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', '94069', 'FR'] ids_count=10
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=10 cols=['ID', 'NOM_COUV', 'taux_chomage_1524_2022']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'taux_chomage_1524_2022': 0.2229004256038335}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'taux_chomage_1524_2022': 0.21676539216704435}, {'ID': 'FR', 'NOM_C
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Pouvez-vous **comparer le taux de ch√¥mage des jeunes (15‚Äì24 ans) √† Vincennes** avec celui des **communes voisines de Vincennes** (par exemple **Saint-Mand√©, Mon' df_rows=10 df_cols=3
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['taux_chomage_1524_2022']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail=' 15 √† 24 ans en 2011"\n‚úÖ TABLE: "ACT_5" | VAR: "p16_pop5564" | DESC: "Population de 55-64 ans en 2016"\n‚úÖ TABLE: "ACT_10" | VAR: "p11_hactocc2554" | DESC: "Hommes actifs occup√©s de 25 √† 54 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['taux_chomage_1524_2022'] formats_keys=['taux_chomage_1524_2022']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['taux_chomage_1524_2022'] formats={'taux_chomage_1524_2022': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage 15-24 ans', 'title': 'Taux de ch√¥mage des 15‚Äì24 ans (2022)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'taux_chomage_1524_2022'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', '94069', 'FR'] selected_metrics=['taux_chomage_1524_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' table='EVO' col='POP_MOCO_40' order=['94067', '200057941', 'D94', 'R11']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'taux_chomage_1524_2022'] formats={'taux_chomage_1524_2022': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage 15-24 ans', 'title': 'Taux de ch√¥mage des 15‚Äì24 ans (2022)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1020
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
