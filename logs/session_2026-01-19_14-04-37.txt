[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Quel isolement des seniors de mon territoire ?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Quel isolement des seniors de mon territoire ?' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le niveau d‚Äôisolement social des seniors sur mon territoire, et comment se r√©partit-il (par √¢ge, sexe, commune/quartier) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] pipeline.geo.after :: new_context=None
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Quel isolement des seniors de mon territoire  √† Vincennes?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=2
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Quel isolement des seniors de mon territoire ?\nuser: Quel isolement des seniors de mon territoire  √† Vincennes?' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le niveau d‚Äôisolement social des personnes √¢g√©es (seniors) sur le territoire de Vincennes ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est uniquement un nom de ville (¬´ Vincennes ¬ª) sans mention d‚Äôintercommunalit√© (agglo, m√©tropole, communaut√©). Selon la r√®gle, on s√©lecti
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes', 'debug_search': [{'Recherche': 'Vincennes
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes', 'debug_search': [{'Recherche': 'Vincennes
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quel est le niveau d‚Äôisolement social des personnes √¢g√©es (seniors) sur le territoire de Vincennes ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quel est le niveau d‚Äôisolement social des personnes √¢g√©es (seniors) sur le territoire de Vincennes ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quel est le niveau d‚Äôisolement social des personnes √¢g√©es (seniors) sur le territoire de Vincennes ?' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5042631707495271
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=914
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7529
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7529 preview='‚úÖ TABLE: "UNKNOWN" | VAR: "RP65+_LOGGRAT" | DESC: "R√©sidences principales occup√©es par des 65 ans ou plus ans log√©s gratuitement en 2022"\n‚úÖ TABLE: "UNKNOWN" | VAR: "D1_75+" | DESC: "Revenu annuel di
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=10723
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(d."P22_POP6579_PSEUL" AS DOUBLE) / NULLIF(TRY_CAST(d."P22_POP6579" AS DOUBLE), 0) AS "part_65_79_vivant_seul",\n  TRY_CAST(d."P22_POP80P_PSEUL" AS DOUBL
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Catalog Error: Table with name UNKNOWN does not exist!
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 1/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  NULL::DOUBLE AS "part_65_79_vivant_seul_2022",\n  NULL::DOUBLE AS "part_80p_vivant_seul_sur_pop_65p_2022"\nFROM territoires t\nWHERE (t."ID" IN (\'94080\', \'200 ids=['94080', '200057941', 'D94', 'R11', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'part_65_79_vivant_seul_2022', 'part_80p_vivant_seul_sur_pop_65p_2022']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'part_65_79_vivant_seul_2022': nan, 'part_80p_vivant_seul_sur_pop_65p_2022': nan}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'part_65_79_vivant_seul_2022': 
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quel est le niveau d‚Äôisolement social des personnes √¢g√©es (seniors) sur le territoire de Vincennes ?' df_rows=5 df_cols=4
[TERRIBOT][DBG] chart.numeric_cols :: count=2 sample=['part_65_79_vivant_seul_2022', 'part_80p_vivant_seul_sur_pop_65p_2022']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='OP5564" | DESC: "Population de 55-64 ans en 2022"\n‚úÖ TABLE: "UNKNOWN" | VAR: "H5054_16" | DESC: "Hommes de 50-54 ans en 2016"\n‚úÖ TABLE: "UNKNOWN" | VAR: "H5559_16" | DESC: "Hommes de 55-59 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['part_80p_vivant_seul_sur_pop_65p_2022'] formats_keys=['part_80p_vivant_seul_sur_pop_65p_2022']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['part_80p_vivant_seul_sur_pop_65p_2022'] formats={'part_80p_vivant_seul_sur_pop_65p_2022': {'kind': 'percent', 'decimals': 1, 'label': '80+ vivant seul', 'title': 'Part des 80 ans ou plus vivant seuls (en % de la population des 65 ans ou plus) en 20
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'part_65_79_vivant_seul_2022', 'part_80p_vivant_seul_sur_pop_65p_2022'] sorted_ids=['94080', '200057941', 'D94', 'R11', 'FR'] selected_metrics=['part_80p_vivant_seul_sur_pop_65p_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'part_65_79_vivant_seul_2022', 'part_80p_vivant_seul_sur_pop_65p_2022'] formats={'part_80p_vivant_seul_sur_pop_65p_2022': {'kind': 'percent', 'decimals': 1, 'label': '80+ vivant seul', 'title': 'Part des 80 ans ou plus vivant seuls (en % de la population des 65 ans ou plus) en 20
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1076
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
