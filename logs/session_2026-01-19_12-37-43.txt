[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üî¥ CODE SUPPRIM√â :
   - # A. Affichage du Graphique (une seule fois ici via le placeholder)
   - if not df.empty:
   - # On r√©cup√®re les IDs finaux depuis le debug_container
   - current_ids = debug_container.get("final_ids", [])
   - auto_plot_data(df, current_ids, config=chart_config, con=con)
   - 
   - # B. Streaming du Texte
   - if not df.empty:
   - print("[TERRIBOT][PIPE] üìù Streaming response start")
   - _dbg("pipeline.stream.inputs", df_rows=len(df), df_cols=list(df.columns), formats=chart_config.get("formats"))
   - 
   - stream = client.chat.completions.create(
   - model=MODEL_NAME,
   - messages=[
   - {"role": "system", "content": f"""
   - Tu es Terribot, un expert en analyse territoriale s'adressant √† des √©lus et agents  des collectivit√©s locales en France.
   - 
   - TON R√îLE :
   - Traduire les donn√©es brutes ci-jointes en une r√©ponse naturelle, fluide et professionnelle.
   - Proposer une piste de r√©flexion pour aller plus loin, sous forme d'une question pour proposer un autre graphique.
   - 
   - R√àGLES D'OR (√Ä RESPECTER STRICTEMENT) :
   - 1. ‚õî NE JAMAIS mentionner "le tableau", "vos donn√©es", "la colonne", "l'extrait" ou "la ligne". Fais comme si tu connaissais ces chiffres par c≈ìur.
   - 2. ‚õî NE JAMAIS citer les noms techniques des variables (ex: "taux_chomage_15_64" ou "indicateur_voisins"). Utilise le langage courant ("Taux de ch√¥mage").
   - 3. ‚õî SI une colonne contient des 0 et des 1 (bool√©ens), NE LES CITE PAS. Interpr√®te-les (ex: "C'est sup√©rieur √† la moyenne").
   - 4. CONTEXTUALISE : Si des villes demand√©es sont absentes des donn√©es, dis simplement "Je dispose des donn√©es pour X et Y" sans dire "dans le fichier fourni".
   - 5. STRUCTURE : Va √† l'essentiel.
   - 
   - Unit√©s des donn√©es : {json.dumps(chart_config.get('formats', {}))}
   - """},
   - {"role": "user", "content": df.to_string()}
   - ],
   - stream=True
   - )
   - full_response_text = message_placeholder.write_stream(stream)
   - _dbg("pipeline.stream.done", response_len=len(full_response_text) if full_response_text else 0)
   - print("[TERRIBOT][PIPE] ‚úÖ Pipeline done")
   - 
   - # C. Affichage Donn√©es (Discret, dans un expander APRES le graphique)
   - with st.expander("üìä Voir les donn√©es brutes", expanded=False):
   - st.dataframe(style_df(df, chart_config.get('formats', {})), width='stretch')
   - 
   - # D. Sauvegarde Historique
   - st.session_state.messages.append({
   - "role": "assistant",
   - "content": full_response_text,
   - "data": df,
   - "chart_config": chart_config,
   - "debug_info": debug_container
   - })
üü¢ CODE AJOUT√â :
   + # A. Affichage du Graphique (une seule fois ici via le placeholder)
   + if not df.empty:
   + # On r√©cup√®re les IDs finaux depuis le debug_container
   + current_ids = debug_container.get("final_ids", [])
   + 
   + auto_plot_data(df, current_ids, config=chart_config, con=con)
   + 
   + # B. Streaming du Texte
   + if not df.empty:
   + print("[TERRIBOT][PIPE] üìù Streaming response start")
   + _dbg("pipeline.stream.inputs", df_rows=len(df), df_cols=list(df.columns), formats=chart_config.get("formats"))
   + 
   + stream = client.chat.completions.create(
   + model=MODEL_NAME,
   + messages=[
   + {"role": "system", "content": f"""
   + Tu es Terribot, un expert en analyse territoriale s'adressant √† des √©lus et agents  des collectivit√©s locales en France.
   + TON R√îLE :
   + Traduire les donn√©es brutes ci-jointes en une r√©ponse naturelle, fluide et professionnelle.
   + Proposer une piste de r√©flexion pour aller plus loin, sous forme d'une question pour proposer un autre graphique.
   + 
   + R√àGLES D'OR (√Ä RESPECTER STRICTEMENT) :
   + 1. ‚õî NE JAMAIS mentionner "le tableau", "vos donn√©es", "la colonne", "l'extrait" ou "la ligne". Fais comme si tu connaissais ces chiffres par c≈ìur.
   + 2. ‚õî NE JAMAIS citer les noms techniques des variables (ex: "taux_chomage_15_64" ou "indicateur_voisins"). Utilise le langage courant ("Taux de ch√¥mage").
   + 3. ‚õî SI une colonne contient des 0 et des 1 (bool√©ens), NE LES CITE PAS. Interpr√®te-les (ex: "C'est sup√©rieur √† la moyenne").
   + 4. CONTEXTUALISE : Si des villes demand√©es sont absentes des donn√©es, dis simplement "Je dispose des donn√©es pour X et Y" sans dire "dans le fichier fourni".
   + 5. STRUCTURE : Va √† l'essentiel.
   + 
   + Unit√©s des donn√©es : {json.dumps(chart_config.get('formats', {}))}
   + """},
   + {"role": "user", "content": df.to_string()}
   + ],
   + stream=True
   + )
   + full_response_text = message_placeholder.write_stream(stream)
   + _dbg("pipeline.stream.done", response_len=len(full_response_text) if full_response_text else 0)
   + print("[TERRIBOT][PIPE] ‚úÖ Pipeline done")
   + 
   + # C. Affichage Donn√©es (Discret, dans un expander APRES le graphique)
   + with st.expander("üìä Voir les donn√©es brutes", expanded=False):
   + st.dataframe(style_df(df, chart_config.get('formats', {})), width='stretch')
   + 
   + # D. Sauvegarde Historique
   + st.session_state.messages.append({
   + "role": "assistant",
   + "content": full_response_text,
   + "data": df,
   + "chart_config": chart_config,
   + "debug_info": debug_container
   + })
========================================

[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üìã Tables valides enregistr√©es : 75
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process="Comment a √©volu√© l'offre de logement depuis les ann√©es 1990 √† Manosque ? " from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail="assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Comment a √©volu√© l'offre de logement depuis les ann√©es 1990 √† Manosque ? " current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "04112",\n  "reason": "La recherche porte uniquement sur le nom de ville ¬´ Manosque ¬ª : selon la r√®gle, on s√©lectionne la commune (code INSEE 5 chiffres). Parmi les candidats, ¬´ M
[TERRIBOT][DBG] pipeline.geo.after :: new_context=None
  Stopping...
