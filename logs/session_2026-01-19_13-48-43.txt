[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üî¥ CODE SUPPRIM√â :
   - const questions = [
   - "Quelle est la structure par √¢ge √† Saint-Malo ?",
   - "Le ch√¥mage baisse-t-il √† Bordeaux ?",
   - "Quelle est la part des cadres √† Lyon ?",
   - "Toutes les communes de la Seine-Saint-Denis",
   - "Niveau de vie m√©dian √† Biarritz ?",
   - "Tous les EPCI de la r√©gion Bretagne",
   - "Densit√© de population √† Paris ?",
   - "Combien de r√©sidences secondaires √† La Baule ?",
   - "Les jeunes partent-ils de Charleville-M√©zi√®res ?",
   - "Quel est le taux de pauvret√© √† Roubaix ?"
üü¢ CODE AJOUT√â :
   + const questions = [
   + "Compare le revenu m√©dian √† Bordeaux et √† Toulouse",
   + "Quel est le taux de ch√¥mage des jeunes √† Marseille ?",
   + "Quelle est la part des cadres √† Neuilly-sur-Seine ?",
   + "Compare la pauvret√© √† Roubaix avec la moyenne nationale",
   + "Y a-t-il plus de propri√©taires √† Vannes ou √† Lorient ?",
   + "Quelle est la part des 15-24 ans √† Rennes ?",
   + "Compare le niveau de vie √† Vincennes et Saint-Mand√©",
   + "Combien de r√©sidences secondaires √† La Rochelle ?",
   + "Quel est le taux de bacheliers √† Strasbourg ?",
   + "Compare la densit√© de population √† Lyon et Villeurbanne",
   + "La part des familles monoparentales √† Saint-Denis",
   + "Compare le ch√¥mage √† Lens avec le d√©partement du Pas-de-Calais",
   + "Quelle est la part de logements sociaux √† Sarcelles ?",
   + "Les revenus sont-ils plus √©lev√©s √† Nantes ou √† Angers ?",
   + "Compare la part des seniors (65+) √† Nice et Menton",
   + "Quel est le taux d'activit√© des femmes √† Lille ?",
   + "Compare les non-dipl√¥m√©s √† Maubeuge et Valenciennes",
   + "Quelle est la taille moyenne des m√©nages √† Paris ?",
   + "Compare le revenu des habitants de Fontenay-sous-Bois aux villes voisines",
   + "Quelle est la part des maisons √† Brest ?"
========================================

[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üìã Tables valides enregistr√©es : 75
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üü¢ CODE AJOUT√â :
   + "Y a t il beaucoup de jeunes √† Saint-Michel dans l'Aisne ?",
========================================

[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='\nCompare Vincennes avec des villes voisines  en termes de pauvret√©' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: \nCompare Vincennes avec des villes voisines  en termes de pauvret√©' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Comparez la commune de Vincennes (Val-de-Marne) avec ses communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-le-Pont) en termes de pauvret√©.'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes (Val-de-Marne)' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=1 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.875}]
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes (Val-de-Marne)' candidates_len=1
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est le nom d‚Äôune ville avec pr√©cision du d√©partement (Val-de-Marne) : selon la r√®gle, on s√©lectionne la commune. Le candidat unique corre
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Mand√©' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '22312', 'NOM_COUV': 'Saint-Maden', 'COMP1': '200068989', 'COMP2': 'D22', 'COMP3': 'R53', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9436363636363637}, {'ID': '33436', 'NOM_COUV': 'Saint-Magne',
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Mand√©' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94067",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte (voisine de Vincennes, Val-de-Marne), il s\'agit de la commune de
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Montreuil' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '28267', 'NOM_COUV': 'Montreuil', 'COMP1': '200040277', 'COMP2': 'D28', 'COMP3': 'R24', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '85148', 'NOM_COUV': 'Montreuil', 'COMP1': '20007193
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Montreuil' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "93048",\n  "reason": "Dans le contexte, il s‚Äôagit des communes voisines de Vincennes (Val-de-Marne) en petite couronne parisienne ; ¬´ Montreuil ¬ª correspond donc √† la commune de 
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Fontenay-sous-Bois' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '94033', 'NOM_COUV': 'Fontenay-sous-Bois', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9555555555555556}, {'ID': '76275', 'NOM_COUV': 'Fonten
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Fontenay-sous-Bois' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94033",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte (voisines de Vincennes, Val-de-Marne), il s\'agit de la commune d
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Charenton-le-Pont' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=6 sample=[{'ID': 'D16', 'NOM_COUV': 'Charente', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.0441176470588236}, {'ID': '94018', 'NOM_COUV': 'Charenton-le-Pont', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Charenton-le-Pont' candidates_len=6
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94018",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte des communes voisines de Vincennes (Val-de-Marne), il s\'agit de 
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Val-de-Marne' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=14 sample=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.0722222222222222}, {'ID': '11080', 'NOM_COUV': 'Val de Lambronne', 
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Val-de-Marne' candidates_len=14
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D94",\n  "reason": "Le terme recherch√© est ¬´ Val-de-Marne ¬ª, qui correspond au d√©partement (code 94). Parmi les candidats, seul ¬´ D94 ¬ª est de type ¬´ D√©partement ¬ª et correspond 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes (Val-de
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes (Val-de
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Comparez la commune de Vincennes (Val-de-Marne) avec ses communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-le-Pont) en termes de pauvret√©.' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Comparez la commune de Vincennes (Val-de-Marne) avec ses communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-le-Pont) en termes' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Comparez la commune de Vincennes (Val-de-Marne) avec ses communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.41462356263229266
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=55
[TERRIBOT][DBG] rag.semantic.return :: final_rows=55
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=55
[TERRIBOT][DBG] rag.hybrid.context :: context_len=6026
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=6026 preview='‚úÖ TABLE: "FILO" | VAR: "tp60_40_49" | DESC: "Taux de pauvret√© au seuil de 60% (%) - M√©nages dont le r√©f√©rent fiscal a de 40 √† 49 ans en 2021"\n‚úÖ TABLE: "FILO" | VAR: "tp60_30_39" | DESC: "Taux de pau
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=9 parent_clause='' sys_prompt_len=9329
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."tp6021" AS DOUBLE) AS "tp6021",\n  TRY_CAST(f."tp60_mono" AS DOUBLE) AS "tp60_mono",\n  TRY_CAST(f."tp60_cae" AS DOUBLE) AS "tp60_cae",\n  TRY_CAST(f
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."tp6021" AS DOUBLE) AS "tp6021",\n  TRY_CAST(f."tp60_mono" AS DOUBLE) AS "tp60_mono",\n  TRY_CAST(f."tp60_cae" AS DOUBLE) AS "tp60_cae",\n  TRY_CAST(f ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', 'FR'] ids_count=9
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=9 cols=['ID', 'NOM_COUV', 'tp6021', 'tp60_mono', 'tp60_cae', 'tp60_cse', 'tp60_hs', 'tp60_fs', 'tp60_30', 'tp60_30_39', 'tp60_40_49', 'tp60_50_59', 'tp60_60_74', 'tp60_75']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': '94067', 'NOM_COUV': 'Saint-Mand√©', 'tp6021': 8.0, 'tp60_mono': 14.0, 'tp60_cae': 5.0, 'tp60_cse': nan, 'tp60_hs': 17.0, 'tp60_fs': 13.0, 'tp60_30': 16.0, 'tp60_30_39': 8.0, 'tp60_40_49': 7.0,
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Comparez la commune de Vincennes (Val-de-Marne) avec ses communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Charenton-le-Pont) en termes' df_rows=9 df_cols=14
[TERRIBOT][DBG] chart.numeric_cols :: count=12 sample=['tp6021', 'tp60_mono', 'tp60_cae', 'tp60_cse', 'tp60_hs', 'tp60_fs', 'tp60_30', 'tp60_30_39', 'tp60_40_49', 'tp60_50_59', 'tp60_60_74', 'tp60_75']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail=': "med_fs" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal est une femme seule en 2021"\n‚úÖ TABLE: "SUP" | VAR: "psdc1968" | DESC: "Population sans double compte en 1968
[TERRIBOT][DBG] chart.config.raw :: selected=['tp6021'] formats_keys=['tp6021']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['tp6021'] formats={'tp6021': {'kind': 'percent', 'decimals': 1, 'label': 'Pauvret√© (60%)', 'title': 'Taux de pauvret√© au seuil de 60% du niveau de vie m√©dian (%) en 2021'}}
[TERRIBOT][DBG] plot.enter :: df_rows=9 df_cols=['ID', 'NOM_COUV', 'tp6021', 'tp60_mono', 'tp60_cae', 'tp60_cse', 'tp60_hs', 'tp60_fs', 'tp60_30', 'tp60_30_39', 'tp60_40_49', 'tp60_50_59'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94018', 'FR'] selected_metrics=['tp6021']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=9 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=9 df_cols=['ID', 'NOM_COUV', 'tp6021', 'tp60_mono', 'tp60_cae', 'tp60_cse', 'tp60_hs', 'tp60_fs', 'tp60_30', 'tp60_30_39', 'tp60_40_49', 'tp60_50_59', 'tp60_60_74', 'tp60_75'] formats={'tp6021': {'kind': 'percent', 'decimals': 1, 'label': 'Pauvret√© (60%)', 'title': 'Taux de pauvret√© au seuil de 60% du niveau de vie m√©dian (%) en 2021'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=2353
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
