[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Compare Vincennes avec 4 villes voisine en termes de richesse' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Compare Vincennes avec 4 villes voisine en termes de richesse' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu comparer la richesse de Vincennes avec celle de quatre villes voisines (par exemple Saint-Mand√©, Montreuil, Nogent-sur-Marne et Fontenay-sous-Bois) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est un nom de ville (¬´ Vincennes ¬ª) dans un contexte de comparaison avec des communes voisines (Saint-Mand√©, Montreuil, Nogent-sur-Marne,
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Mand√©' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '22312', 'NOM_COUV': 'Saint-Maden', 'COMP1': '200068989', 'COMP2': 'D22', 'COMP3': 'R53', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9436363636363637}, {'ID': '33436', 'NOM_COUV': 'Saint-Magne',
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Mand√©' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94067",\n  "reason": "Le terme recherch√© est un nom de ville (¬´ Saint-Mand√© ¬ª) dans un contexte de comparaison avec des communes voisines de Vincennes ; selon la r√®gle 1, on s√©le
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Montreuil' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '28267', 'NOM_COUV': 'Montreuil', 'COMP1': '200040277', 'COMP2': 'D28', 'COMP3': 'R24', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '85148', 'NOM_COUV': 'Montreuil', 'COMP1': '20007193
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Montreuil' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "93048",\n  "reason": "Dans le contexte, il s‚Äôagit de la ville voisine de Vincennes (Val-de-Marne) : Montreuil en Seine-Saint-Denis (93). L‚Äôutilisateur a saisi uniquement un nom d
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Nogent-sur-Marne' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=8 sample=[{'ID': '94052', 'NOM_COUV': 'Nogent-sur-Marne', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.95}, {'ID': '10267', 'NOM_COUV': 'Nogent-sur-Aube', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Nogent-sur-Marne' candidates_len=8
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94052",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; on s√©lectionne donc la commune. Parmi les candidats, \\"Nogent-sur-Marne\\" corres
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Fontenay-sous-Bois' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '94033', 'NOM_COUV': 'Fontenay-sous-Bois', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9555555555555556}, {'ID': '76275', 'NOM_COUV': 'Fonten
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Fontenay-sous-Bois' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94033",\n  "reason": "Le terme recherch√© est le nom d‚Äôune ville (¬´ Fontenay-sous-Bois ¬ª) dans un contexte de comparaison entre communes voisines de Vincennes ; on retient donc la
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94052', '94033', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes, Saint-
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94052', '94033', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes, Saint-
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu comparer la richesse de Vincennes avec celle de quatre villes voisines (par exemple Saint-Mand√©, Montreuil, Nogent-sur-Marne et Fontenay-sous-Bois) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu comparer la richesse de Vincennes avec celle de quatre villes voisines (par exemple Saint-Mand√©, Montreuil, Nogent-sur-Marne et Fontenay-sous-Bois) ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu comparer la richesse de Vincennes avec celle de quatre villes voisines (par exemple Saint-Mand√©, Montreuil, Noge' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.3747152779320482
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=38
[TERRIBOT][DBG] rag.semantic.return :: final_rows=38
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=38
[TERRIBOT][DBG] rag.hybrid.context :: context_len=3164
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=3164 preview='‚úÖ TABLE: "FILO" | VAR: "d9_15" | DESC: "Revenu annuel disponible au 9√®me d√©cile en 2015"\n‚úÖ TABLE: "SUP" | VAR: "psdc1982" | DESC: "Population sans double compte en 1982"\n‚úÖ TABLE: "SUP" | VAR: "pmun
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=9 parent_clause='' sys_prompt_len=6451
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."med21" AS DOUBLE) AS "revenu_median_2021",\n  TRY_CAST(f."d121" AS DOUBLE) AS "revenu_d1_2021",\n  TRY_CAST(f."d921" AS DOUBLE) AS "revenu_d9_2021",\
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."med21" AS DOUBLE) AS "Revenu_median_annuel_disponible_2021",\n  TRY_CAST(f."d121" AS DOUBLE) AS "Revenu_1er_decile_2021",\n  TRY_CAST(f."d921" AS DOU ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94052', '94033', 'FR'] ids_count=9
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=9 cols=['ID', 'NOM_COUV', 'Revenu_median_annuel_disponible_2021', 'Revenu_1er_decile_2021', 'Revenu_9eme_decile_2021', 'Rapport_D9_D1_2021', 'Taux_de_pauvrete_60pct_2021']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'Revenu_median_annuel_disponible_2021': 24270.0, 'Revenu_1er_decile_2021': 11200.0, 'Revenu_9eme_decile_2021': 46890.0, 'Rapport_D9_D1_2021': 4.1866071428571
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu comparer la richesse de Vincennes avec celle de quatre villes voisines (par exemple Saint-Mand√©, Montreuil, Nogent-sur-Marne et Fontenay-sous-Bois) ?' df_rows=9 df_cols=7
[TERRIBOT][DBG] chart.numeric_cols :: count=5 sample=['Revenu_median_annuel_disponible_2021', 'Revenu_1er_decile_2021', 'Revenu_9eme_decile_2021', 'Rapport_D9_D1_2021', 'Taux_de_pauvrete_60pct_2021']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='cipale en 2017"\n‚úÖ TABLE: "FILO" | VAR: "tp6021" | DESC: "Taux de pauvret√© au seuil de 60% du revenu m√©dian disponible en 2021"\n‚úÖ TABLE: "SUP" | VAR: "pmun2022" | DESC: "Population municipale en 202
[TERRIBOT][DBG] chart.config.raw :: selected=['Revenu_median_annuel_disponible_2021'] formats_keys=['Revenu_median_annuel_disponible_2021']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['Revenu_median_annuel_disponible_2021'] formats={'Revenu_median_annuel_disponible_2021': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian', 'title': 'Revenu m√©dian annuel disponible (2021)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=9 df_cols=['ID', 'NOM_COUV', 'Revenu_median_annuel_disponible_2021', 'Revenu_1er_decile_2021', 'Revenu_9eme_decile_2021', 'Rapport_D9_D1_2021', 'Taux_de_pauvrete_60pct_2021'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94052', '94033', 'FR'] selected_metrics=['Revenu_median_annuel_disponible_2021']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=9 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=9 df_cols=['ID', 'NOM_COUV', 'Revenu_median_annuel_disponible_2021', 'Revenu_1er_decile_2021', 'Revenu_9eme_decile_2021', 'Rapport_D9_D1_2021', 'Taux_de_pauvrete_60pct_2021'] formats={'Revenu_median_annuel_disponible_2021': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian', 'title': 'Revenu m√©dian annuel disponible (2021)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=2587
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
