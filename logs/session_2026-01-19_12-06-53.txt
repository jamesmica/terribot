[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process="Quelles sont les conditions de scolarisation et d'apprentissage pour les enfants de Roubaix ?" from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail="assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Quelles sont les conditions de scolarisation et d'apprentissage pour les enfants de Roubaix ?" current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quelles sont les conditions de scolarisation et d‚Äôapprentissage des enfants √† Roubaix (acad√©mie de Lille), notamment en termes d‚Äôacc√®s aux √©tablissements, de qualit√© de l‚Äôenseignement, de moyens (eff
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Roubaix' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=6 sample=[{'ID': '59512', 'NOM_COUV': 'Roubaix', 'COMP1': '200093201', 'COMP2': 'D59', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '11324', 'NOM_COUV': 'Roubia', 'COMP1': '200035863', '
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Roubaix' candidates_len=6
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "59512",\n  "reason": "La recherche contient uniquement le nom de la ville ¬´ Roubaix ¬ª : selon la r√®gle 1, on s√©lectionne la Commune (code INSEE 5 chiffres). Parmi les candidats, 
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Acad√©mie de Lille' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=0 sample=[]
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Acad√©mie de Lille' candidates_len=0
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Lille' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '59350', 'NOM_COUV': 'Lille', 'COMP1': '200093201', 'COMP2': 'D59', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '62516', 'NOM_COUV': 'Lillers', 'COMP1': '200072460', 'C
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Lille' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "59350",\n  "reason": "La recherche est uniquement le nom de ville ¬´ Lille ¬ª : selon la r√®gle 1, on s√©lectionne la commune (code INSEE √† 5 chiffres). Parmi les candidats, ¬´ Lille 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Roubaix', 'target_id': '59512', 'all_ids': ['59512', '200093201', 'D59', 'R32', '59350', 'FR'], 'parent_clause': '', 'display_context': 'Roubaix, Acad√©mie de Lille, Lille', 'debug_sea
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Roubaix', 'target_id': '59512', 'all_ids': ['59512', '200093201', 'D59', 'R32', '59350', 'FR'], 'parent_clause': '', 'display_context': 'Roubaix, Acad√©mie de Lille, Lille', 'debug_sea
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quelles sont les conditions de scolarisation et d‚Äôapprentissage des enfants √† Roubaix (acad√©mie de Lille), notamment en termes d‚Äôacc√®s aux √©tablissements, de qualit√© de l‚Äôenseignement, de moyens (eff df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quelles sont les conditions de scolarisation et d‚Äôapprentissage des enfants √† Roubaix (acad√©mie de Lille), notamment en termes d‚Äôacc√®s aux √©tablissements, de qu' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quelles sont les conditions de scolarisation et d‚Äôapprentissage des enfants √† Roubaix (acad√©mie de Lille), notamment en ' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.48533068127752177
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=214
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=8670 candidates=80
[TERRIBOT][RAG] ‚úÖ context built (hybrid)
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=8670 preview='‚úÖ TABLE: "DIPL" | VAR: "6-10_AUTREG" | DESC: "Population des 6 √† 10 ans scolaris√©s dans une autre r√©gion en France m√©tropolitaine en 2022"\n‚úÖ TABLE: "DIPL" | VAR: "3-5_AUTREG" | DESC: "Population des
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=6 parent_clause='' sys_prompt_len=12153
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n\n  /* Acc√®s / scolarisation (parts par lieu de scolarisation) */\n  TRY_CAST(d."P22_SCOL0205" AS DOUBLE) / NULLIF(TRY_CAST(d."P22_POP0205" AS DOUBLE), 0) AS part_
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "d" does not have a column named "3_5_COMRES"
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 1/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "d" does not have a column named "3_5_AUTCOMDEP"
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 2/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "d" does not have a column named "3_5_AUTDEP"
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 3/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "d" does not have a column named "3_5_AUTREG"
[TERRIBOT][FATAL] Exception: BinderException('Binder Error: Values list "d" does not have a column named "3_5_AUTREG"\n\nLINE 6:   TRY_CAST(d."3_5_AUTREG" AS DOUBLE) / NULLIF(TRY_CAST(d."P22_POP0205...\n                   ^')
Traceback (most recent call last):
  File "C:\Users\james\Downloads\terribot\app.py", line 1434, in <module>
    sql_query = generate_and_fix_sql(client, MODEL_NAME, system_prompt, rewritten_prompt, con)
  File "C:\Users\james\Downloads\terribot\app.py", line 454, in generate_and_fix_sql
    raise e
  File "C:\Users\james\Downloads\terribot\app.py", line 426, in generate_and_fix_sql
    con.execute(f"EXPLAIN {sql_query}")
    ~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^
_duckdb.BinderException: Binder Error: Values list "d" does not have a column named "3_5_AUTREG"

LINE 6:   TRY_CAST(d."3_5_AUTREG" AS DOUBLE) / NULLIF(TRY_CAST(d."P22_POP0205...
                   ^

  Stopping...
