[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Quels sont les revenus des familles de la CA saint quentin en yvelines ?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Quels sont les revenus des familles de la CA saint quentin en yvelines ?' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quels sont les revenus des familles vivant dans la communaut√© d‚Äôagglom√©ration de Saint-Quentin-en-Yvelines (Yvelines, France) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Quentin-en-Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=7 sample=[{'ID': '2691', 'NOM_COUV': 'Saint-Quentin', 'COMP1': '200071892', 'COMP2': 'D2', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.8806153846153846}, {'ID': '16346', 'NOM_COUV': 'Saint-Quentin
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Quentin-en-Yvelines' candidates_len=7
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "200058782",\n  "reason": "La requ√™te ¬´ Saint-Quentin-en-Yvelines ¬ª d√©signe usuellement l‚Äôintercommunalit√© (CA de Saint Quentin en Yvelines) et le candidat correspondant est de ty
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.45}, {'ID': '55543', 'NOM_COUV': 'Velaines', 'COMP1': '200033025', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Yvelines' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D78",\n  "reason": "La recherche \\"Yvelines\\" correspond au nom du d√©partement ; parmi les candidats, seul \\"Yvelines\\" est un territoire de type D√©partement (ID D78).",\n  "
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='France' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': 'FR', 'NOM_COUV': 'France m√©tropolitaine', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'Pays', 'score': 1.0045454545454544}, {'ID': '37110', 'NOM_COUV': 'Francueil', 'COMP1
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='France' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "FR",\n  "reason": "La recherche \\"France\\" correspond au territoire de type \\"Pays\\" pr√©sent dans la liste (ID FR : France m√©tropolitaine). Les autres candidats sont des comm
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Saint-Quentin-en-Yvelines, 
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Saint-Quentin-en-Yvelines, 
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quels sont les revenus des familles vivant dans la communaut√© d‚Äôagglom√©ration de Saint-Quentin-en-Yvelines (Yvelines, France) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quels sont les revenus des familles vivant dans la communaut√© d‚Äôagglom√©ration de Saint-Quentin-en-Yvelines (Yvelines, France) ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quels sont les revenus des familles vivant dans la communaut√© d‚Äôagglom√©ration de Saint-Quentin-en-Yvelines (Yvelines, Fr' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5088518782540692
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=829
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=9252 candidates=80
[TERRIBOT][RAG] ‚úÖ context built (hybrid)
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=9252 preview='‚úÖ TABLE: "FILO" | VAR: "MED_CAE" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal est un couple avec enfant(s) en 2021"\n‚úÖ TABLE: "FILO" | VAR: "MED_MONO" | DESC: "Reven
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=12478
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."MED21" AS DOUBLE) AS MED21,\n  TRY_CAST(f."MED_CAE" AS DOUBLE) AS MED_CAE,\n  TRY_CAST(f."MED_CSE" AS DOUBLE) AS MED_CSE,\n  TRY_CAST(f."MED_MONO" AS
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."MED21" AS DOUBLE) AS MED21,\n  TRY_CAST(f."MED_CAE" AS DOUBLE) AS MED_CAE,\n  TRY_CAST(f."MED_CSE" AS DOUBLE) AS MED_CSE,\n  TRY_CAST(f."MED_MONO" AS ids=['200058782', '78423', 'D78', 'R11', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'MED21': 28130.0, 'MED_CAE': 29740.0, 'MED_CSE': 34000.0, 'MED_MONO': 20710.0, 'MED_COMPLEX': 24390.0, 'D121': 13610.0, 'D921': 53140.0, 'NBMENFISC21': 587390.0,
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quels sont les revenus des familles vivant dans la communaut√© d‚Äôagglom√©ration de Saint-Quentin-en-Yvelines (Yvelines, France) ?' df_rows=5 df_cols=11
[TERRIBOT][DBG] chart.numeric_cols :: count=9 sample=['MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='16_1524_CAE" | DESC: "Population des 15-24 ans en couple avec enfant(s) en 2016"\n‚úÖ TABLE: "CMF_10" | VAR: "C11_1524_MONO" | DESC: "Population des 15-24 ans adulte d\'une famille monoparentale en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['MED21'] formats_keys=['MED21']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['MED21'] formats={'MED21': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian', 'title': 'Revenu disponible m√©dian par unit√© de consommation (2021)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['MED21']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21'] formats={'MED21': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian', 'title': 'Revenu disponible m√©dian par unit√© de consommation (2021)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=2098
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['MED21']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Oui' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=3
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='stribution qui reste significatif : l‚Äôenjeu social n‚Äôest pas absent, m√™me dans une commune globalement ais√©e.\n\n### Piste pour aller plus loin\nSouhaitez-vous un graphique qui compare, pour chaque t current_geo_name='CA de Saint Quentin en Yvelines'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Pouvez-vous produire **un graphique comparant, dans la CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines**, l‚Äô**√©cart de revenu m√©dian** entre **familles monoparentales** et **couples avec enfants** (en **euros** et e
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='CA de Saint Quentin en Yvelines'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=3 sample=[{'ID': '200058782', 'NOM_COUV': 'CA de Saint Quentin en Yvelines', 'COMP1': '78423', 'COMP2': 'D78', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'EPCI/Interco', 'score': 0.9806451612903226}, {'ID': '200071892
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines' candidates_len=3
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "200058782",\n  "reason": "La requ√™te mentionne explicitement \\"CA\\" (Communaut√© d‚Äôagglom√©ration) et le nom correspond √† \\"CA de Saint Quentin en Yvelines\\" (EPCI) dans les Yv
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint‚ÄëQuentin‚Äëen‚ÄëYvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '2691', 'NOM_COUV': 'Saint-Quentin', 'COMP1': '200071892', 'COMP2': 'D2', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.8937062937062936}, {'ID': '51511', 'NOM_COUV': 'Saint-Quentin
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint‚ÄëQuentin‚Äëen‚ÄëYvelines' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": null,\n  "reason": "La recherche ¬´ Saint‚ÄëQuentin‚Äëen‚ÄëYvelines ¬ª d√©signe habituellement l‚ÄôEPCI (CA Saint‚ÄëQuentin‚Äëen‚ÄëYvelines, code SIREN 200058782) et non une commune. Or aucun cand
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.45}, {'ID': '55543', 'NOM_COUV': 'Velaines', 'COMP1': '200033025', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Yvelines' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D78",\n  "reason": "La recherche \\"Yvelines\\" correspond au nom du d√©partement ; parmi les candidats, seul \\"Yvelines\\" est un territoire de type D√©partement (ID D78).",\n  "
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvel
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvel
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Pouvez-vous produire **un graphique comparant, dans la CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines**, l‚Äô**√©cart de revenu m√©dian** entre **familles monoparentales** et **couples avec enfants** (en **euros** et e df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Pouvez-vous produire **un graphique comparant, dans la CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines**, l‚Äô**√©cart de revenu m√©dian** entre **familles monoparentales** et **co' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Pouvez-vous produire **un graphique comparant, dans la CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines**, l‚Äô**√©cart de revenu m√©dian** e' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.611602328750431
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1262
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=10530 candidates=80
[TERRIBOT][RAG] ‚úÖ context built (hybrid)
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=10530 preview='‚úÖ TABLE: "FILO" | VAR: "MED_CAE" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal est un couple avec enfant(s) en 2021"\n‚úÖ TABLE: "FILO" | VAR: "TP60_CAE" | DESC: "Taux 
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=13848
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."MED_MONO" AS DOUBLE) AS "REV_MED_MONO_EUR",\n  TRY_CAST(f."MED_CAE"  AS DOUBLE) AS "REV_MED_CAE_EUR",\n  (TRY_CAST(f."MED_MONO" AS DOUBLE) - TRY_CAST
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(d."MED_MONO" AS DOUBLE) AS MED_MONO_EUR,\n  TRY_CAST(d."MED_CAE" AS DOUBLE) AS MED_CAE_EUR,\n  (TRY_CAST(d."MED_MONO" AS DOUBLE) - TRY_CAST(d."MED_CAE"  ids=['200058782', '78423', 'D78', 'R11', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': '200058782', 'NOM_COUV': 'CA de Saint Quentin en Yvelines', 'MED_MONO_EUR': 19720.0, 'MED_CAE_EUR': 26820.0, 'ECART_EUR': -7100.0, 'ECART_PCT': -26.472781506338553}, {'ID': '78423', 'NOM_COUV'
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Pouvez-vous produire **un graphique comparant, dans la CA de Saint‚ÄëQuentin‚Äëen‚ÄëYvelines**, l‚Äô**√©cart de revenu m√©dian** entre **familles monoparentales** et **co' df_rows=5 df_cols=6
[TERRIBOT][DBG] chart.numeric_cols :: count=4 sample=['MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail=': "ENF_6-10A_41" | DESC: "Enfant de 6 √† 10 ans d\'un couple o√π les deux ont le statut d\'actif en emploi en 2022"\n‚úÖ TABLE: "FILO" | VAR: "D921" | DESC: "Revenu annuel disponible au 9√®me d√©cile en 20
[TERRIBOT][DBG] chart.config.raw :: selected=['ECART_EUR', 'ECART_PCT'] formats_keys=['ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['ECART_EUR', 'ECART_PCT'] formats={'ECART_EUR': {'kind': 'currency', 'decimals': 0, 'label': '√âcart (‚Ç¨)', 'title': '√âcart de revenu m√©dian (familles monoparentales - couples avec enfants), en euros'}, 'ECART_PCT': {'kind': 'percent', 
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=True y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT'] formats={'ECART_EUR': {'kind': 'currency', 'decimals': 0, 'label': '√âcart (‚Ç¨)', 'title': '√âcart de revenu m√©dian (familles monoparentales - couples avec enfants), en euros'}, 'ECART_PCT': {'kind': 'percent', 
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1423
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['MED21']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=True y_format=',.0f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Oui' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=5
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='cc√®s aux ressources pour les familles monoparentales m√™me dans un territoire globalement favoris√©.\n\n**Pour aller plus loin :** souhaitez-vous un graphique qui montre, pour chaque territoire, **le r current_geo_name='CA de Saint Quentin en Yvelines'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Pouvez-vous produire, pour la **CA de Saint-Quentin-en-Yvelines**, un **graphique en barres c√¥te √† c√¥te** comparant le **revenu m√©dian (2021) des familles monoparentales** et celui des **couples avec
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='CA de Saint Quentin en Yvelines'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='CA de Saint-Quentin-en-Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=3 sample=[{'ID': '200058782', 'NOM_COUV': 'CA de Saint Quentin en Yvelines', 'COMP1': '78423', 'COMP2': 'D78', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'EPCI/Interco', 'score': 1.3}, {'ID': '200071892', 'NOM_COUV': 
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='CA de Saint-Quentin-en-Yvelines' candidates_len=3
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "200058782",\n  "reason": "La requ√™te contient \\"CA de Saint-Quentin-en-Yvelines\\" : il s‚Äôagit explicitement d‚Äôune communaut√© d‚Äôagglom√©ration (EPCI). Le candidat 200058782 corre
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Quentin-en-Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=7 sample=[{'ID': '2691', 'NOM_COUV': 'Saint-Quentin', 'COMP1': '200071892', 'COMP2': 'D2', 'COMP3': 'R32', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.8806153846153846}, {'ID': '16346', 'NOM_COUV': 'Saint-Quentin
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Quentin-en-Yvelines' candidates_len=7
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "200058782",\n  "reason": "La recherche correspond √† ¬´ Saint-Quentin-en-Yvelines ¬ª, qui d√©signe l‚Äôintercommunalit√© (CA de Saint Quentin en Yvelines) et non une commune ; parmi les
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.45}, {'ID': '55543', 'NOM_COUV': 'Velaines', 'COMP1': '200033025', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Yvelines' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D78",\n  "reason": "La recherche \\"Yvelines\\" correspond au nom du d√©partement ; parmi les candidats, seul \\"Yvelines\\" est un territoire de type D√©partement (ID D78).",\n  "
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'CA de Saint-Quentin-en-Yvel
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'CA de Saint-Quentin-en-Yvel
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Pouvez-vous produire, pour la **CA de Saint-Quentin-en-Yvelines**, un **graphique en barres c√¥te √† c√¥te** comparant le **revenu m√©dian (2021) des familles monoparentales** et celui des **couples avec df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Pouvez-vous produire, pour la **CA de Saint-Quentin-en-Yvelines**, un **graphique en barres c√¥te √† c√¥te** comparant le **revenu m√©dian (2021) des familles monop' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Pouvez-vous produire, pour la **CA de Saint-Quentin-en-Yvelines**, un **graphique en barres c√¥te √† c√¥te** comparant le *' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.59509030716237
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1280
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=10619 candidates=80
[TERRIBOT][RAG] ‚úÖ context built (hybrid)
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=10619 preview='‚úÖ TABLE: "FILO" | VAR: "MED_CAE" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal est un couple avec enfant(s) en 2021"\n‚úÖ TABLE: "FILO" | VAR: "TP60_CAE" | DESC: "Taux 
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=14043
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."MED_MONO" AS DOUBLE) AS "Revenu_median_2021_familles_monoparentales",\n  TRY_CAST(f."MED_CAE" AS DOUBLE)  AS "Revenu_median_2021_couples_avec_enfants
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  \'Revenu m√©dian (2021)\' AS "indicateur",\n  TRY_CAST(f."MED_MONO" AS DOUBLE) AS "familles_monoparentales",\n  TRY_CAST(f."MED_CAE" AS DOUBLE) AS "couples_avec_e ids=['200058782', '78423', 'D78', 'R11', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'indicateur', 'familles_monoparentales', 'couples_avec_enfants']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'indicateur': 'Revenu m√©dian (2021)', 'familles_monoparentales': 20710.0, 'couples_avec_enfants': 29740.0}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'indicateu
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Pouvez-vous produire, pour la **CA de Saint-Quentin-en-Yvelines**, un **graphique en barres c√¥te √† c√¥te** comparant le **revenu m√©dian (2021) des familles monop' df_rows=5 df_cols=5
[TERRIBOT][DBG] chart.numeric_cols :: count=2 sample=['familles_monoparentales', 'couples_avec_enfants']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='C: "Population des 15-24 ans chez le(s) parents(s) en 2016"\n‚úÖ TABLE: "FILO" | VAR: "MED_40-49" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal a de 40 √† 49 ans en 2021
[TERRIBOT][DBG] chart.config.raw :: selected=['familles_monoparentales', 'couples_avec_enfants'] formats_keys=['familles_monoparentales', 'couples_avec_enfants']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['familles_monoparentales', 'couples_avec_enfants'] formats={'familles_monoparentales': {'kind': 'currency', 'decimals': 0, 'label': 'Mono (m√©dian ‚Ç¨)', 'title': 'Revenu m√©dian annuel disponible (2021) ‚Äî Familles monoparentales (‚Ç¨)'}, 'couples_avec_enfants': {'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'indicateur', 'familles_monoparentales', 'couples_avec_enfants'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['familles_monoparentales', 'couples_avec_enfants']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=True y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'indicateur', 'familles_monoparentales', 'couples_avec_enfants'] formats={'familles_monoparentales': {'kind': 'currency', 'decimals': 0, 'label': 'Mono (m√©dian ‚Ç¨)', 'title': 'Revenu m√©dian annuel disponible (2021) ‚Äî Familles monoparentales (‚Ç¨)'}, 'couples_avec_enfants': {'
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1412
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED21', 'MED_CAE', 'MED_CSE', 'MED_MONO', 'MED_COMPLEX', 'D121', 'D921', 'NBMENFISC21', 'NBPERSMENFISC21'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['MED21']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'MED_MONO_EUR', 'MED_CAE_EUR', 'ECART_EUR', 'ECART_PCT'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['ECART_EUR', 'ECART_PCT']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=True y_format=',.0f'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'indicateur', 'familles_monoparentales', 'couples_avec_enfants'] sorted_ids=['200058782', '78423', 'D78', 'R11', 'FR'] selected_metrics=['familles_monoparentales', 'couples_avec_enfants']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=5 top_5_ids=['200058782', '78423', 'D78', 'R11', 'FR'] final_order=['200058782', '78423', 'D78', 'R11', 'FR']
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=True y_format=',.0f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Non, compare la CA √† Vincennes, Fontenay sous bois, Meaux' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=7
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='nement socio-√©conomique plus favoris√© de la commune que l‚Äôintercommunalit√© prise dans son ensemble.\n\n**Pour aller plus loin :** souhaitez-vous un graphique montrant **l‚Äô√©cart de revenu entre couple current_geo_name='CA de Saint Quentin en Yvelines'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu **comparer le revenu m√©dian annuel disponible (2021)** de la **CA de Saint-Quentin-en-Yvelines**, pour les **familles monoparentales** et les **couples avec enfants**, avec les communes de **
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='CA de Saint Quentin en Yvelines'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='CA de Saint-Quentin-en-Yvelines' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=3 sample=[{'ID': '200058782', 'NOM_COUV': 'CA de Saint Quentin en Yvelines', 'COMP1': '78423', 'COMP2': 'D78', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'EPCI/Interco', 'score': 1.3}, {'ID': '200071892', 'NOM_COUV': 
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='CA de Saint-Quentin-en-Yvelines' candidates_len=3
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "200058782",\n  "reason": "La requ√™te contient \\"CA de Saint-Quentin-en-Yvelines\\" : il s‚Äôagit explicitement d‚Äôune communaut√© d‚Äôagglom√©ration (EPCI). Le candidat 200058782 corre
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "La recherche contient uniquement le nom de la ville ¬´ Vincennes ¬ª : selon la r√®gle 1, on s√©lectionne la commune (code INSEE √† 5 chiffres). Parmi les candida
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Fontenay-sous-Bois' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '94033', 'NOM_COUV': 'Fontenay-sous-Bois', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9555555555555556}, {'ID': '76275', 'NOM_COUV': 'Fonten
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Fontenay-sous-Bois' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94033",\n  "reason": "La recherche correspond exactement √† la commune ¬´ Fontenay-sous-Bois ¬ª (r√®gle 1 : nom de ville seul => Commune, code INSEE √† 5 chiffres).",\n  "is_ambiguous
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Meaux' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '77284', 'NOM_COUV': 'Meaux', 'COMP1': '200072130', 'COMP2': 'D77', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '17233', 'NOM_COUV': 'Meux', 'COMP1': '200041523', 'COMP
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Meaux' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "77284",\n  "reason": "La recherche est un nom de ville seul (¬´ Meaux ¬ª) : selon la r√®gle 1, on s√©lectionne la commune correspondante. Parmi les candidats, ¬´ Meaux ¬ª correspond ex
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', '94080', '94033', '77284', 'FR'], 'parent_clause': '', 'display_context': '
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'CA de Saint Quentin en Yvelines', 'target_id': '200058782', 'all_ids': ['200058782', '78423', 'D78', 'R11', '94080', '94033', '77284', 'FR'], 'parent_clause': '', 'display_context': '
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu **comparer le revenu m√©dian annuel disponible (2021)** de la **CA de Saint-Quentin-en-Yvelines**, pour les **familles monoparentales** et les **couples avec enfants**, avec les communes de ** df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu **comparer le revenu m√©dian annuel disponible (2021)** de la **CA de Saint-Quentin-en-Yvelines**, pour les **familles monoparentales** et les **couples ' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu **comparer le revenu m√©dian annuel disponible (2021)** de la **CA de Saint-Quentin-en-Yvelines**, pour les **fam' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.6407812816540306
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1322
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=10930 candidates=80
[TERRIBOT][RAG] ‚úÖ context built (hybrid)
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=10930 preview='‚úÖ TABLE: "FILO" | VAR: "MED_CAE" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal est un couple avec enfant(s) en 2021"\n‚úÖ TABLE: "FILO" | VAR: "MED_MONO" | DESC: "Reven
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=8 parent_clause='' sys_prompt_len=14380
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(d."MED_MONO" AS DOUBLE) AS "MED_MONO_2021",\n  TRY_CAST(d."MED_CAE" AS DOUBLE) AS "MED_CAE_2021",\n  (TRY_CAST(d."MED_CAE" AS DOUBLE) - TRY_CAST(d."MED_
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(d."MED_MONO" AS DOUBLE) AS "MED_MONO_2021",\n  TRY_CAST(d."MED_CAE" AS DOUBLE) AS "MED_CAE_2021",\n  (TRY_CAST(d."MED_CAE" AS DOUBLE) - TRY_CAST(d."MED_ ids=['200058782', '78423', 'D78', 'R11', '94080', '94033', '77284', 'FR'] ids_count=8
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=8 cols=['ID', 'NOM_COUV', 'MED_MONO_2021', 'MED_CAE_2021', 'ECART_CAE_MOINS_MONO_2021']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D78', 'NOM_COUV': 'Yvelines', 'MED_MONO_2021': 20710.0, 'MED_CAE_2021': 29740.0, 'ECART_CAE_MOINS_MONO_2021': 9030.0}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'MED_MONO_2021': 19160.0, 'ME
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu **comparer le revenu m√©dian annuel disponible (2021)** de la **CA de Saint-Quentin-en-Yvelines**, pour les **familles monoparentales** et les **couples ' df_rows=8 df_cols=5
[TERRIBOT][DBG] chart.numeric_cols :: count=3 sample=['MED_MONO_2021', 'MED_CAE_2021', 'ECART_CAE_MOINS_MONO_2021']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='famille principale est compos√©e d\'un couple de deux actif en emploi en 2022"\n‚úÖ TABLE: "CMF" | VAR: "MFPMONOH" | DESC: "M√©nages dont la famille principale est compos√©e d\'un homme monoparental en 20
[TERRIBOT][DBG] chart.config.raw :: selected=['ECART_CAE_MOINS_MONO_2021'] formats_keys=['ECART_CAE_MOINS_MONO_2021']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['ECART_CAE_MOINS_MONO_2021'] formats={'ECART_CAE_MOINS_MONO_2021': {'kind': 'currency', 'decimals': 0, 'label': '√âcart (CAE - mono)', 'title': '√âcart de revenu m√©dian annuel disponible 2021 : couples avec enfants moins familles monoparen
[TERRIBOT][DBG] plot.enter :: df_rows=8 df_cols=['ID', 'NOM_COUV', 'MED_MONO_2021', 'MED_CAE_2021', 'ECART_CAE_MOINS_MONO_2021'] sorted_ids=['200058782', '78423', 'D78', 'R11', '94080', '94033', '77284', 'FR'] selected_metrics=['ECART_CAE_MOINS_MONO_2021']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.ids :: available=8 top_5_ids=['200058782', '78423', 'D78', 'R11', '94080'] final_order=['200058782', '78423', 'D78', 'R11', '94080']
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=8 df_cols=['ID', 'NOM_COUV', 'MED_MONO_2021', 'MED_CAE_2021', 'ECART_CAE_MOINS_MONO_2021'] formats={'ECART_CAE_MOINS_MONO_2021': {'kind': 'currency', 'decimals': 0, 'label': '√âcart (CAE - mono)', 'title': '√âcart de revenu m√©dian annuel disponible 2021 : couples avec enfants moins familles monoparen
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1961
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
