[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process="\nComment a √©volu√© l'offre de logement depuis les ann√©es 1990 √† Manosque ?" from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail="assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: \nComment a √©volu√© l'offre de logement depuis les ann√©es 1990 √† Manosque ?" current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est uniquement le nom de ville ¬´ Manosque ¬ª : selon la r√®gle, on s√©lectionne la commune correspondante (code INSEE 04112, affich√© ici sans le z√©
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.49744761690490485
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=190
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7415
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7415 preview='‚úÖ TABLE: "LOG" | VAR: "log90" | DESC: "Logements en 1990"\n‚úÖ TABLE: "LOG" | VAR: "rp_1971_90" | DESC: "R√©sidences principales construites entre 1971 et 1990"\n‚úÖ TABLE: "LOG" | VAR: "log75" | DESC: "L
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=10587
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(l."log90" AS DOUBLE) / NULLIF(TRY_CAST(l."log22" AS DOUBLE), 0) AS "part_logements_1990_dans_2022",\n  TRY_CAST(l."log99" AS DOUBLE) / NULLIF(TRY_CAST(l
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(l90."log90" AS DOUBLE) AS "logements_1990",\n  TRY_CAST(l99."log99" AS DOUBLE) AS "logements_1999",\n  TRY_CAST(l11."log11" AS DOUBLE) AS "logements_201 ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D4', 'NOM_COUV': 'Alpes de Haute-Provence', 'logements_1990': 92368.0, 'logements_1999': 102293.0, 'logements_2011': 120706.4866063157, 'logements_2016': 126760.40425593164, 'logements_2022':
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Comment l‚Äôoffre de logements a-t-elle √©volu√© √† Manosque depuis les ann√©es 1990 ?' df_rows=5 df_cols=12
[TERRIBOT][DBG] chart.numeric_cols :: count=10 sample=['logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='022"\n‚úÖ TABLE: "LOG" | VAR: "rp2529_prop" | DESC: "R√©sidences principales occup√©es par des 25-29 ans propri√©taires en 2022"\n‚úÖ TABLE: "LOG_10" | VAR: "p11_appart" | DESC: "Logement appartement en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['evol_1990_2022'] formats_keys=['evol_1990_2022']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['evol_1990_2022'] formats={'evol_1990_2022': {'kind': 'percent', 'decimals': 1, 'label': '√âvol. 1990-2022', 'title': '√âvolution du nombre de logements entre 1990 et 2022'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] formats={'evol_1990_2022': {'kind': 'percent', 'decimals': 1, 'label': '√âvol. 1990-2022', 'title': '√âvolution du nombre de logements entre 1990 et 2022'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1466
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Fais une courbe' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=3
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='√† une attractivit√© r√©sidentielle et/ou √† une production de logements plus dynamique.\n\n**Pour aller plus loin :** souhaitez-vous un graphique qui compare, pour chaque p√©riode (1990‚Äë1999, 1999‚Äë2011,  current_geo_name='Manosque'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu tracer une **courbe d‚Äô√©volution du nombre de logements √† Manosque** (1990 ‚Üí 2022), √† partir des valeurs : **8\u202f695 (1990)** et **13\u202f268 (2022)**, et si possible avec les **points int
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Manosque'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est un nom de ville seul (¬´ Manosque ¬ª) : selon la r√®gle 1, on s√©lectionne la commune correspondante. Parmi les candidats, seule la commune ¬´ Ma
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu tracer une **courbe d‚Äô√©volution du nombre de logements √† Manosque** (1990 ‚Üí 2022), √† partir des valeurs : **8\u202f695 (1990)** et **13\u202f268 (2022)**, et si possible avec les **points int df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu tracer une **courbe d‚Äô√©volution du nombre de logements √† Manosque** (1990 ‚Üí 2022), √† partir des valeurs : **8\u202f695 (1990)** et **13\u202f268 (2022)**, et si p' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu tracer une **courbe d‚Äô√©volution du nombre de logements √† Manosque** (1990 ‚Üí 2022), √† partir des valeurs : **8\u202f69' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5865576511521318
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1628
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7765
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7765 preview='‚úÖ TABLE: "LOG" | VAR: "log90" | DESC: "Logements en 1990"\n‚úÖ TABLE: "LOG" | VAR: "rp_1971_90" | DESC: "R√©sidences principales construites entre 1971 et 1990"\n‚úÖ TABLE: "LOG" | VAR: "log68" | DESC: "L
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=11131
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  x."annee",\n  x."logements"\nFROM territoires t\nLEFT JOIN (\n  SELECT\n    t0."ID",\n    1990 AS "annee",\n    TRY_CAST(l90."log90" AS DOUBLE) AS "logements"\n 
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  x."annee",\n  x."logements"\nFROM territoires t\nLEFT JOIN "LOG" d ON t."ID" = d."ID"\nLEFT JOIN "LOG_10" d10 ON t."ID" = d10."ID"\nCROSS JOIN (\n  SELECT 1990 A ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=25 cols=['ID', 'NOM_COUV', 'annee', 'logements']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': '200034700', 'NOM_COUV': 'CA Durance-Lub√©ron-Verdon Agglom√©ration', 'annee': 1990, 'logements': 26265.0}, {'ID': '200034700', 'NOM_COUV': 'CA Durance-Lub√©ron-Verdon Agglom√©ration', 'annee': 19
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu tracer une **courbe d‚Äô√©volution du nombre de logements √† Manosque** (1990 ‚Üí 2022), √† partir des valeurs : **8\u202f695 (1990)** et **13\u202f268 (2022)**, et si p' df_rows=25 df_cols=4
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['logements']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='cc_acc" | DESC: "R√©sidences principales suroccupation accentu√©e en 2022"\n‚úÖ TABLE: "LOG" | VAR: "rp1529_5p" | DESC: "R√©sidences principales dont personne de r√©f√©rence de 15-29 ans de 5 pi√®ces en 2022
[TERRIBOT][DBG] chart.config.raw :: selected=['logements'] formats_keys=['logements']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements'}}
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1573
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Pour Manosque seulement' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=5
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='om√©ration et Manosque se situent donc sur une croissance **plus rapide** que les moyennes r√©gionale et nationale sur longue p√©riode.\n\n**Piste pour aller plus loin :** souhaitez-vous un graphique qu current_geo_name='Manosque'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu tracer **une courbe d‚Äô√©volution du nombre de logements √† Manosque**, de **1990 √† 2022** (par ann√©es de recensement : **1990, 1999, 2011, 2016 et 2022**) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Manosque'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est exactement ¬´ Manosque ¬ª sans mention d‚Äôintercommunalit√© ; selon la r√®gle, on s√©lectionne la commune correspondante (ID INSEE 04112, affich√© 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu tracer **une courbe d‚Äô√©volution du nombre de logements √† Manosque**, de **1990 √† 2022** (par ann√©es de recensement : **1990, 1999, 2011, 2016 et 2022**) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu tracer **une courbe d‚Äô√©volution du nombre de logements √† Manosque**, de **1990 √† 2022** (par ann√©es de recensement : **1990, 1999, 2011, 2016 et 2022**)' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu tracer **une courbe d‚Äô√©volution du nombre de logements √† Manosque**, de **1990 √† 2022** (par ann√©es de recenseme' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5893825123738085
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1520
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7823
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7823 preview='‚úÖ TABLE: "LOG" | VAR: "log90" | DESC: "Logements en 1990"\n‚úÖ TABLE: "LOG" | VAR: "rp_1971_90" | DESC: "R√©sidences principales construites entre 1971 et 1990"\n‚úÖ TABLE: "LOG" | VAR: "log68" | DESC: "L
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=11077
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  \'1990\' AS "annee",\n  TRY_CAST(d."log90" AS DOUBLE) AS "logements"\nFROM territoires t\nLEFT JOIN "LOG" d ON t."ID" = d."ID"\nWHERE (t."ID" IN (\'4112\', \'200
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  x."annee",\n  x."logements"\nFROM territoires t\nLEFT JOIN "LOG" d ON t."ID" = d."ID"\nCROSS JOIN (\n  VALUES\n    (1990, TRY_CAST(d."log90" AS DOUBLE)),\n    (1 ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=25 cols=['ID', 'NOM_COUV', 'annee', 'logements']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': '200034700', 'NOM_COUV': 'CA Durance-Lub√©ron-Verdon Agglom√©ration', 'annee': 1990, 'logements': 26265.0}, {'ID': '200034700', 'NOM_COUV': 'CA Durance-Lub√©ron-Verdon Agglom√©ration', 'annee': 19
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu tracer **une courbe d‚Äô√©volution du nombre de logements √† Manosque**, de **1990 √† 2022** (par ann√©es de recensement : **1990, 1999, 2011, 2016 et 2022**)' df_rows=25 df_cols=4
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['logements']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='PLS" | VAR: "nb_ls2022" | DESC: "Nombre de logements sociaux en 2022"\n‚úÖ TABLE: "LOG" | VAR: "RP65+2p" | DESC: "R√©sidences principales dont personne de r√©f√©rence de plus de 65 ans de 2 pi√®ces en 2022
[TERRIBOT][DBG] chart.config.raw :: selected=['logements'] formats_keys=['logements']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements (total)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements (total)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1486
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Enl√®ve les territoires de comparaison' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=7
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='ide** que le d√©partement, la r√©gion et la moyenne nationale sur la p√©riode 1990‚Äì2022.\n\n### Pour aller plus loin\nSouhaitez-vous un graphique montrant **la part de Manosque dans le parc de logements current_geo_name='Manosque'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Entre **1990 et 2022**, le **parc de logements √† Manosque** progresse nettement :\n\n- **1990 : 8\u202f695 logements**\n- **2022 : 13\u202f268 logements**\n\nSoit **+4\u202f573 logements** en 32 ans,
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Manosque'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est un nom de ville seul (¬´ Manosque ¬ª) : selon la r√®gle, on s√©lectionne la commune correspondante. Parmi les candidats, ¬´ Manosque ¬ª (Commune) 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Entre **1990 et 2022**, le **parc de logements √† Manosque** progresse nettement :\n\n- **1990 : 8\u202f695 logements**\n- **2022 : 13\u202f268 logements**\n\nSoit **+4\u202f573 logements** en 32 ans, df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Entre **1990 et 2022**, le **parc de logements √† Manosque** progresse nettement :\n\n- **1990 : 8\u202f695 logements**\n- **2022 : 13\u202f268 logements**\n\nSoit **+4\u202f573 log' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Entre **1990 et 2022**, le **parc de logements √† Manosque** progresse nettement :\n\n- **1990 : 8\u202f695 logements**\n- **2022' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5804810475954724
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1552
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7823
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7823 preview='‚úÖ TABLE: "RPLS" | VAR: "age_moyen" | DESC: "√Çge moyen des logements sociaux en 2024"\n‚úÖ TABLE: "LOG" | VAR: "log90" | DESC: "Logements en 1990"\n‚úÖ TABLE: "LOG" | VAR: "log68" | DESC: "Logements en 19
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=11125
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(d."log90" AS DOUBLE) AS "logements_1990",\n  TRY_CAST(d."log22" AS DOUBLE) AS "logements_2022",\n  (TRY_CAST(d."log22" AS DOUBLE) - TRY_CAST(d."log90" A
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(l."log90" AS DOUBLE) AS "logements_1990",\n  TRY_CAST(l."log22" AS DOUBLE) AS "logements_2022",\n  (TRY_CAST(l."log22" AS DOUBLE) - TRY_CAST(l."log90" A ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D4', 'NOM_COUV': 'Alpes de Haute-Provence', 'logements_1990': 92368.0, 'logements_2022': 132550.12257880057, 'evolution_absolue_1990_2022': 40182.12257880057, 'evolution_pourcent_1990_2022': 
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Entre **1990 et 2022**, le **parc de logements √† Manosque** progresse nettement :\n\n- **1990 : 8\u202f695 logements**\n- **2022 : 13\u202f268 logements**\n\nSoit **+4\u202f573 log' df_rows=5 df_cols=6
[TERRIBOT][DBG] chart.numeric_cols :: count=4 sample=['logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='es par des 15-24 ans locataires HLM en 2022"\n‚úÖ TABLE: "RPLS" | VAR: "nb_ls2016" | DESC: "Nombre de logements sociaux en 2016"\n‚úÖ TABLE: "SITADL" | VAR: "logaut20" | DESC: "Logements autoris√©s en 202
[TERRIBOT][DBG] chart.config.raw :: selected=['evolution_pourcent_1990_2022'] formats_keys=['evolution_pourcent_1990_2022']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['evolution_pourcent_1990_2022'] formats={'evolution_pourcent_1990_2022': {'kind': 'percent', 'decimals': 1, 'label': '√âvolution 1990-2022', 'title': '√âvolution du parc de logements entre 1990 et 2022 (en %)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evolution_pourcent_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022'] formats={'evolution_pourcent_1990_2022': {'kind': 'percent', 'decimals': 1, 'label': '√âvolution 1990-2022', 'title': '√âvolution du parc de logements entre 1990 et 2022 (en %)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1110
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evolution_pourcent_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process="Fais une courbe de l'√©volution du nombre de logements depuis 1990 sans comparaison" from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=9
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail="e particuli√®rement marqu√©e √† l‚Äô√©chelle du bassin de vie.\n\n**Pour aller plus loin :** souhaitez-vous un graphique qui compare **l‚Äô√©volution en %** et **les gains en nombre de logements** (deux barre current_geo_name='Manosque'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu faire une courbe de l‚Äô√©volution du **nombre de logements √† Manosque** depuis **1990**, **sans aucun territoire de comparaison** (uniquement Manosque) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Manosque'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est un nom de ville seul (¬´ Manosque ¬ª) : selon la r√®gle 1, on s√©lectionne la commune correspondante. Parmi les candidats, ¬´ Manosque ¬ª (Commune
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu faire une courbe de l‚Äô√©volution du **nombre de logements √† Manosque** depuis **1990**, **sans aucun territoire de comparaison** (uniquement Manosque) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu faire une courbe de l‚Äô√©volution du **nombre de logements √† Manosque** depuis **1990**, **sans aucun territoire de comparaison** (uniquement Manosque) ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu faire une courbe de l‚Äô√©volution du **nombre de logements √† Manosque** depuis **1990**, **sans aucun territoire d' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5424662393677571
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=794
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7810
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7810 preview='‚úÖ TABLE: "LOG" | VAR: "log90" | DESC: "Logements en 1990"\n‚úÖ TABLE: "LOG" | VAR: "rp_1971_90" | DESC: "R√©sidences principales construites entre 1971 et 1990"\n‚úÖ TABLE: "LOG" | VAR: "log75" | DESC: "L
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=11061
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  x."annee",\n  x."logements"\nFROM territoires t\nLEFT JOIN "LOG" d ON t."ID" = d."ID"\nCROSS JOIN (\n  VALUES\n    (1990, TRY_CAST(d."log90" AS DOUBLE)),\n    (1
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  x."annee",\n  x."logements"\nFROM territoires t\nLEFT JOIN (\n  SELECT "ID", 1990 AS "annee", TRY_CAST("log90" AS DOUBLE) AS "logements" FROM "LOG"\n  UNION ALL\ ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'annee', 'logements']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'annee': 1990, 'logements': 8695.0}, {'ID': '4112', 'NOM_COUV': 'Manosque', 'annee': 1999, 'logements': 9720.0}, {'ID': '4112', 'NOM_COUV': 'Manosque', 'annee':
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu faire une courbe de l‚Äô√©volution du **nombre de logements √† Manosque** depuis **1990**, **sans aucun territoire de comparaison** (uniquement Manosque) ?' df_rows=5 df_cols=4
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['logements']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='√©sidences principales occup√©es par des 15-24 ans locataires HLM en 2022"\n‚úÖ TABLE: "LOG" | VAR: "rp1529_1p" | DESC: "R√©sidences principales dont personne de r√©f√©rence de 15-29 ans d\'une pi√®ce en 202
[TERRIBOT][DBG] chart.config.raw :: selected=['logements'] formats_keys=['logements']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] formats={'logements': {'kind': 'number', 'decimals': 0, 'label': 'Logements', 'title': 'Nombre de logements'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=833
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_1999', 'logements_2011', 'logements_2016', 'logements_2022', 'evol_1990_1999', 'evol_1999_2011', 'evol_2011_2016', 'evol_2016_2022', 'evol_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evol_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][DBG] plot.enter :: df_rows=25 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=25 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'logements_1990', 'logements_2022', 'evolution_absolue_1990_2022', 'evolution_pourcent_1990_2022'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['evolution_pourcent_1990_2022']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'annee', 'logements'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['logements']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col='annee' id_col='ID'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=False is_multi_metric=False y_format=',.1f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Les b√¢timents publics sont ils performants √©nergetiquement ?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=11
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='r√©centes** (croissance plus forte jusqu‚Äôen 2011, puis plus mod√©r√©e ensuite).\n\n**Pour aller plus loin :** souhaitez-vous un graphique qui montre **les gains de logements par p√©riode** (barres des √©v current_geo_name='Manosque'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Les **b√¢timents publics √† Manosque** sont-ils **performants √©nerg√©tiquement** (par exemple au regard de leur **DPE**, de leurs **consommations** et/ou de leur **niveau de r√©novation**) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Manosque'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "La recherche est exactement ¬´ Manosque ¬ª sans mention d‚Äôintercommunalit√© ; selon la r√®gle, on s√©lectionne la commune correspondante (ID INSEE 04112, affich√© 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque', 'debug_search': [{'Recherche': 'Manosque', 'Tr
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Les **b√¢timents publics √† Manosque** sont-ils **performants √©nerg√©tiquement** (par exemple au regard de leur **DPE**, de leurs **consommations** et/ou de leur **niveau de r√©novation**) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Les **b√¢timents publics √† Manosque** sont-ils **performants √©nerg√©tiquement** (par exemple au regard de leur **DPE**, de leurs **consommations** et/ou de leur *' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Les **b√¢timents publics √† Manosque** sont-ils **performants √©nerg√©tiquement** (par exemple au regard de leur **DPE**, de' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5885298700675837
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=260
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=9449
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=9449 preview='‚úÖ TABLE: "DPE" | VAR: "b_dpe" | DESC: "Diagnostic de Performance √ânerg√©tique B - √ânergie des logements en 2025"\n‚úÖ TABLE: "DPE" | VAR: "a_dpe" | DESC: "Diagnostic de Performance √ânerg√©tique A - √ânerg
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=12727
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n\n  /* DPE tertiaire (locaux non r√©sidentiels) : parts par classe (√©nergie) */\n  TRY_CAST(dt."dpe_tertiaire_a" AS DOUBLE) / NULLIF(TRY_CAST(dt."tot_tertiaire_dpe"
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n\n  /* DPE tertiaire (locaux non r√©sidentiels) : parts par classe (√©nergie) */\n  TRY_CAST(dt."dpe_tertiaire_a" AS DOUBLE) / NULLIF(TRY_CAST(dt."tot_tertiaire_dpe" ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'part_dpe_tertiaire_a_energie', 'part_dpe_tertiaire_b_energie', 'part_dpe_tertiaire_c_energie', 'part_dpe_tertiaire_d_energie', 'part_dpe_tertiaire_e_energie', 'part_dpe_tertiaire_f
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D4', 'NOM_COUV': 'Alpes de Haute-Provence', 'part_dpe_tertiaire_a_energie': 0.09180790960451977, 'part_dpe_tertiaire_b_energie': 0.1596045197740113, 'part_dpe_tertiaire_c_energie': 0.25706214
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Les **b√¢timents publics √† Manosque** sont-ils **performants √©nerg√©tiquement** (par exemple au regard de leur **DPE**, de leurs **consommations** et/ou de leur *' df_rows=5 df_cols=24
[TERRIBOT][DBG] chart.numeric_cols :: count=22 sample=['part_dpe_tertiaire_a_energie', 'part_dpe_tertiaire_b_energie', 'part_dpe_tertiaire_c_energie', 'part_dpe_tertiaire_d_energie', 'part_dpe_tertiaire_e_energie', 'part_dpe_tertiaire_f_energie', 'part_d
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail=' en 2024"\n‚úÖ TABLE: "DATA_ES" | VAR: "gestion_departement" | DESC: "Gestionnaire d√©partement en 2025"\n‚úÖ TABLE: "REN" | VAR: "x93_11z_gestion_privee" | DESC: "Gestion d‚Äôinstallations sportives en 202
[TERRIBOT][DBG] chart.config.raw :: selected=['part_dpe_tertiaire_energie_A_C'] formats_keys=['part_dpe_tertiaire_energie_A_C']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['part_dpe_tertiaire_energie_A_C'] formats={'part_dpe_tertiaire_energie_A_C': {'kind': 'percent', 'decimals': 1, 'label': 'DPE A-C', 'title': 'Part des b√¢timents tertiaires (publics) class√©s A √† C au DPE √©nergie'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'part_dpe_tertiaire_a_energie', 'part_dpe_tertiaire_b_energie', 'part_dpe_tertiaire_c_energie', 'part_dpe_tertiaire_d_energie', 'part_dpe_tertiaire_e_energie', 'part_dpe_tertiaire_f sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['part_dpe_tertiaire_energie_A_C']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='failed' reason='Colonne population introuvable dans territoires.txt'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'part_dpe_tertiaire_a_energie', 'part_dpe_tertiaire_b_energie', 'part_dpe_tertiaire_c_energie', 'part_dpe_tertiaire_d_energie', 'part_dpe_tertiaire_e_energie', 'part_dpe_tertiaire_f formats={'part_dpe_tertiaire_energie_A_C': {'kind': 'percent', 'decimals': 1, 'label': 'DPE A-C', 'title': 'Part des b√¢timents tertiaires (publics) class√©s A √† C au DPE √©nergie'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=2465
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
