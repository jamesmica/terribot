[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üî¥ CODE SUPPRIM√â :
   - # 5. EXECUTION
   - 
   - if not df.empty:
   - st.write("üé® Configuration graphique...")
   - 
   - status_container.update(label="Analyse termin√©e", state="complete", expanded=False)
   - # --- ZONE D'AFFICHAGE UNIQUE (LIVE) ---
   - status_container.empty()
üü¢ CODE AJOUT√â :
   + 
   + 
   + 
   + # On configure le graph PENDANT que le loader est encore l√†
   + # üõë SUPPRESSION : On n'√©crit plus "Analyse termin√©e".
   + # On laisse le container tel quel, il sera d√©truit juste apr√®s.
   + # --- SORTIE DU CONTEXTE 'with status_container:' ---
   + 
   + # üí£ DESTRUCTION TOTALE DU LOADER ICI
   + status_container.empty()
========================================

[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üìã Tables valides enregistr√©es : 75
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='\nQuel isolement des seniors de mon territoire √† Vincennes?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: \nQuel isolement des seniors de mon territoire √† Vincennes?' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le niveau d‚Äôisolement social des seniors (personnes √¢g√©es) sur mon territoire √† Vincennes (Val-de-Marne), et comment se r√©partit-il (par quartiers ou types de m√©nages) ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=13 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': 'D86', 'NOM_COUV': 'Vienne', 'COMP1': None, 'COMP2':
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes' candidates_len=13
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est un nom de ville (¬´ Vincennes ¬ª) et le contexte pr√©cise ¬´ Vincennes (Val-de-Marne) ¬ª : il s‚Äôagit donc de la commune INSEE 94080 (d√©par
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Val-de-Marne' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=14 sample=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.0722222222222222}, {'ID': '11080', 'NOM_COUV': 'Val de Lambronne', 
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Val-de-Marne' candidates_len=14
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D94",\n  "reason": "Le terme recherch√© est ¬´ Val-de-Marne ¬ª, qui correspond au d√©partement (code 94). Parmi les candidats, seul ¬´ D94 ¬ª est de type D√©partement ; les autres sont 
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes, Val-de-Marne', 'debug_search': [{'Recherch
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', 'FR'], 'parent_clause': '', 'display_context': 'Vincennes, Val-de-Marne', 'debug_search': [{'Recherch
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quel est le niveau d‚Äôisolement social des seniors (personnes √¢g√©es) sur mon territoire √† Vincennes (Val-de-Marne), et comment se r√©partit-il (par quartiers ou types de m√©nages) ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quel est le niveau d‚Äôisolement social des seniors (personnes √¢g√©es) sur mon territoire √† Vincennes (Val-de-Marne), et comment se r√©partit-il (par quartiers ou t' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quel est le niveau d‚Äôisolement social des seniors (personnes √¢g√©es) sur mon territoire √† Vincennes (Val-de-Marne), et co' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.4960965562365621
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=892
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=7319
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=7319 preview='‚úÖ TABLE: "CMF" | VAR: "p22_pop6579_pseul" | DESC: "Population de 65-79 ans vivant seul en 2022"\n‚úÖ TABLE: "CMF" | VAR: "p22_pop80p_pseul" | DESC: "Population de 80 ans ou plus vivant seul en 2022"\n‚úÖ
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=10591
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  /* Volumes (2022) */\n  TRY_CAST(cmf."p22_pop6579_pseul" AS DOUBLE) AS "p22_pop6579_pseul",\n  TRY_CAST(cmf."p22_pop80p_pseul" AS DOUBLE) AS "p22_pop80p_pseul",\
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "cmf" does not have a column named "65+_SEUL"
[TERRIBOT][SQL] üïµÔ∏è Alias r√©solu : 'cmf' -> 'CMF'
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 1/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  /* Volumes (2022) */\n  TRY_CAST(cmf."p22_pop6579_pseul" AS DOUBLE) AS "p22_pop6579_pseul",\n  TRY_CAST(cmf."p22_pop80p_pseul" AS DOUBLE) AS "p22_pop80p_pseul",\ ids=['94080', '200057941', 'D94', 'R11', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'p22_pop6579_pseul', 'p22_pop80p_pseul', 'p22_pop6579', 'p22_pop80p', 'part_6579_vivant_seul', 'part_80p_vivant_seul', 'part_65p_vivant_seul', 'x65_seul', 'x65_coupl', 'x65_aut', 'p
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'p22_pop6579_pseul': 48497.88102247378, 'p22_pop80p_pseul': 28716.74188883915, 'p22_pop6579': 152649.13124973045, 'p22_pop80p': 64025.473446354794, 'part_657
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quel est le niveau d‚Äôisolement social des seniors (personnes √¢g√©es) sur mon territoire √† Vincennes (Val-de-Marne), et comment se r√©partit-il (par quartiers ou t' df_rows=5 df_cols=21
[TERRIBOT][DBG] chart.numeric_cols :: count=19 sample=['p22_pop6579_pseul', 'p22_pop80p_pseul', 'p22_pop6579', 'p22_pop80p', 'part_6579_vivant_seul', 'part_80p_vivant_seul', 'part_65p_vivant_seul', 'x65_seul', 'x65_coupl', 'x65_aut', 'part_menages_ref_65
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail=': "Population des 15-24 ans habitant seul.e en 2016"\n‚úÖ TABLE: "EVO_10" | VAR: "h5054_11" | DESC: "Hommes de 50-54 ans en 2011"\n‚úÖ TABLE: "EVO_5" | VAR: "f6569_16" | DESC: "Femmes de 65-69 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['part_65p_vivant_seul'] formats_keys=['part_65p_vivant_seul']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['part_65p_vivant_seul'] formats={'part_65p_vivant_seul': {'kind': 'percent', 'decimals': 1, 'label': '65+ vivant seul', 'title': 'Part des personnes de 65 ans ou plus vivant seules (proxy d‚Äôisolement social)'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'p22_pop6579_pseul', 'p22_pop80p_pseul', 'p22_pop6579', 'p22_pop80p', 'part_6579_vivant_seul', 'part_80p_vivant_seul', 'part_65p_vivant_seul', 'x65_seul', 'x65_coupl', 'x65_aut'] sorted_ids=['94080', '200057941', 'D94', 'R11', 'FR'] selected_metrics=['part_65p_vivant_seul']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'p22_pop6579_pseul', 'p22_pop80p_pseul', 'p22_pop6579', 'p22_pop80p', 'part_6579_vivant_seul', 'part_80p_vivant_seul', 'part_65p_vivant_seul', 'x65_seul', 'x65_coupl', 'x65_aut', 'p formats={'part_65p_vivant_seul': {'kind': 'percent', 'decimals': 1, 'label': '65+ vivant seul', 'title': 'Part des personnes de 65 ans ou plus vivant seules (proxy d‚Äôisolement social)'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1606
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
