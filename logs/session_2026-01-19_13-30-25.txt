[TERRIBOT] üìù D√©marrage de l'enregistrement des logs

========================================
üõ†Ô∏è CODE MODIFI√â DPUIS LA DERNI√àRE EX√âCUTION
üî¥ CODE SUPPRIM√â :
   - # S√©paration : Cible (toujours en 1er) vs Comparateurs (√† trier)
   - # 2. TRI VISUEL (TAILLE / POPULATION VIA TABLE 'EVO')
   - # S√©paration : Cible (toujours en 1er) vs Comparateurs (√† trier)
   - if top_5_ids:
   - target_id = top_5_ids[0]
   - comparators = [x for x in top_5_ids[1:]] # Copie propre
   - sorted_comparators = comparators
   - 
   - # On ne trie que s'il y a une connexion DB et des comparateurs
   - # A. Identifier la table EVO disponible
   - # On r√©cup√®re la liste des tables valides stock√©e en session
   - # On cherche une table qui contient "EVO" (ex: EVO, EVO_10, EVO_5)
   - # B. Trouver la colonne population la plus r√©cente (ex: P21_POP)
   - 
   - # On cherche les colonnes qui ressemblent √† Pxx_POP ou Pxx_PMUN
   - # Ex: P21_POP, P19_POP...
   - 
   - # On prend la derni√®re par ordre alphab√©tique (souvent l'ann√©e la plus r√©cente P21 > P19)
   - 
   - # Fallback si pas de Pxx_POP : on cherche juste 'POP' ou 'PMUN'
   - if not pop_col:
   - pop_col = next((c for c in evo_cols if c in ["POP", "PMUN", "PTOT", "POPULATION"]), None)
   - ids_sql_list = ", ".join([f"'{i}'" for i in comparators])
   - 
   - # C. Requ√™te de tri sur la table EVO
   - # Pas besoin de REPLACE/CAST car EVO est d√©j√† num√©rique normalement
   - WHERE t.ID IN ({ids_sql_list})
   - sorted_comparators = [str(x[0]) for x in con.execute(q_sort).fetchall()]
   - _dbg("plot.sort", status="success", table=evo_table, col=pop_col, order=sorted_comparators)
   - else:
   - _dbg("plot.sort", status="failed", reason=f"Colonne POP introuvable dans {evo_table}")
   - else:
   - _dbg("plot.sort", status="failed", reason="Table EVO introuvable")
   - 
   - # Reconstitution : Cible + Comparateurs tri√©s
   - final_display_order = [target_id] + sorted_comparators
   - 
   - # Filtre final du DataFrame
üü¢ CODE AJOUT√â :
   + # 2. TRI VISUEL (Cible en premier, puis les autres par taille)
   + # On r√©cup√®re les IDs disponibles dans la data
   + available_ids = df_plot[id_col].unique().tolist()
   + 
   + # On filtre la liste d'entr√©e pour ne garder que ceux qui ont des donn√©es
   + candidates = [str(x) for x in sorted_ids if str(x) in available_ids]
   + if not candidates: candidates = available_ids # Fallback
   + 
   + if candidates:
   + # A. La Cible est TOUJOURS le premier √©l√©ment de la liste 'candidates'
   + # (car analyze_territorial_scope met toujours le target_id en premier)
   + target_id = candidates[0]
   + 
   + # B. Les Comparateurs sont le reste de la liste
   + comparators = candidates[1:]
   + 
   + # C. On ne trie QUE les comparateurs
   + # Recherche colonne POP (inchang√©e)
   + if not pop_col: pop_col = next((c for c in evo_cols if c in ["POP", "PMUN", "PTOT", "POPULATION"]), None)
   + ids_sql = ", ".join([f"'{i}'" for i in comparators])
   + # Tri Ascendant des comparateurs uniquement
   + WHERE t.ID IN ({ids_sql})
   + # On r√©cup√®re la liste tri√©e
   + comparators = [str(x[0]) for x in con.execute(q_sort).fetchall()]
   + _dbg("plot.sort", status="success", col=pop_col)
   + # D. Assemblage Final : Cible + Comparateurs tri√©s
   + final_display_order = [target_id] + comparators
   + 
   + # E. On coupe √† 15 pour la lisibilit√©
   + final_display_order = final_display_order[:15]
   + 
   + # F. Application du filtre
========================================

[TERRIBOT][DB] ‚ñ∂Ô∏è get_db_connection() ENTER
[TERRIBOT][DBG] db.data_dir :: data_dir='data' exists=True
[TERRIBOT][DB] üì¶ Parquets d√©tect√©s: 75 -> ['aah.parquet', 'acci.parquet', 'act.parquet', 'act_10.parquet', 'act_5.parquet', 'aeeh.parquet', 'all.parquet', 'all30.parquet', 'apl.parquet', 'artif.parquet']
[TERRIBOT][DB] üìã Tables valides enregistr√©es : 75
[TERRIBOT][DB] üì¶ 75 vues cr√©√©es.
[TERRIBOT][DBG] db.meta_paths :: glossaire_path='data/Glossaire.txt' territoires_path='data/territoires.txt' glossaire_exists=True territoires_exists=True
[TERRIBOT][DB] üîé FTS init...
[TERRIBOT][DB] ‚úÖ FTS index created on glossaire
[TERRIBOT][DB] ‚úÖ get_db_connection() EXIT
[TERRIBOT][EMB] ‚ñ∂Ô∏è get_glossary_embeddings ENTER
[TERRIBOT][DBG] emb.df_glossaire :: empty=False rows=2043 cols=['Source', 'Onglet', 'Rep√®re', 'Ann√©e de r√©f√©rence', 'Nom au sein de la base de donn√©es', 'Intitul√© d√©taill√©', 'Onglets', 'Nb th√©matiques']
[TERRIBOT][DBG] emb.cleaned :: clean_texts_len=2043 valid_indices_len=2043
[TERRIBOT][DBG] emb.cache :: cache_path='data\\embeddings_cache.npy' cache_exists=True
[TERRIBOT][DBG] emb.cache_loaded :: embeddings_shape=(2043, 1536)
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Compare le revenu des habitants de  Vincennes avec des villes voisines' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=False ambiguity=False messages=1
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='assistant: Bonjour ! Quel territoire souhaitez-vous analyser ?\nuser: Compare le revenu des habitants de  Vincennes avec des villes voisines' current_geo_name=''
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Peux-tu comparer le revenu moyen (ou m√©dian) des habitants de Vincennes (Val-de-Marne) avec celui des communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Nogent-sur-Marne et Ch
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo=None
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Vincennes (Val-de-Marne)' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=1 sample=[{'ID': '94080', 'NOM_COUV': 'Vincennes', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.875}]
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Vincennes (Val-de-Marne)' candidates_len=1
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94080",\n  "reason": "Le terme recherch√© est un nom de ville avec pr√©cision du d√©partement (Val-de-Marne) : selon la r√®gle 1, on s√©lectionne la commune. Le candidat \'Vincennes\'
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Saint-Mand√©' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '22312', 'NOM_COUV': 'Saint-Maden', 'COMP1': '200068989', 'COMP2': 'D22', 'COMP3': 'R53', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9436363636363637}, {'ID': '33436', 'NOM_COUV': 'Saint-Magne',
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Saint-Mand√©' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94067",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte il s\'agit de Saint-Mand√© (Val-de-Marne, D94). Le candidat corres
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Montreuil' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=15 sample=[{'ID': '28267', 'NOM_COUV': 'Montreuil', 'COMP1': '200040277', 'COMP2': 'D28', 'COMP3': 'R24', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '85148', 'NOM_COUV': 'Montreuil', 'COMP1': '20007193
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Montreuil' candidates_len=15
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "93048",\n  "reason": "Le terme recherch√© est un nom de ville seul (¬´ Montreuil ¬ª) : on s√©lectionne donc la commune. Le contexte mentionne Vincennes (Val-de-Marne) et des communes
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Fontenay-sous-Bois' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '94033', 'NOM_COUV': 'Fontenay-sous-Bois', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.9555555555555556}, {'ID': '76275', 'NOM_COUV': 'Fonten
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Fontenay-sous-Bois' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94033",\n  "reason": "Le terme recherch√© est un nom de commune (¬´ Fontenay-sous-Bois ¬ª) et le contexte pr√©cise le Val-de-Marne ; parmi les candidats, seule la commune INSEE 94033
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Nogent-sur-Marne' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=8 sample=[{'ID': '94052', 'NOM_COUV': 'Nogent-sur-Marne', 'COMP1': '200057941', 'COMP2': 'D94', 'COMP3': 'R11', 'TYPE_TERRITOIRE': 'Commune', 'score': 0.95}, {'ID': '10267', 'NOM_COUV': 'Nogent-sur-Aube', 'COM
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Nogent-sur-Marne' candidates_len=8
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94052",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte il s\'agit de Nogent-sur-Marne (Val-de-Marne). Le candidat corres
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Charenton-le-Pont' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=6 sample=[{'ID': 'D16', 'NOM_COUV': 'Charente', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.0441176470588236}, {'ID': '94018', 'NOM_COUV': 'Charenton-le-Pont', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Charenton-le-Pont' candidates_len=6
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "94018",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; dans le contexte, il s\'agit de la commune voisine de Vincennes. Le candidat corre
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'], 'parent_clause': '', 'display_context': 'Vincenne
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Vincennes', 'target_id': '94080', 'all_ids': ['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'], 'parent_clause': '', 'display_context': 'Vincenne
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Peux-tu comparer le revenu moyen (ou m√©dian) des habitants de Vincennes (Val-de-Marne) avec celui des communes voisines (par exemple Saint-Mand√©, Montreuil, Fontenay-sous-Bois, Nogent-sur-Marne et Ch df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Peux-tu comparer le revenu moyen (ou m√©dian) des habitants de Vincennes (Val-de-Marne) avec celui des communes voisines (par exemple Saint-Mand√©, Montreuil, Fon' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Peux-tu comparer le revenu moyen (ou m√©dian) des habitants de Vincennes (Val-de-Marne) avec celui des communes voisines ' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.4921667001742105
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=1007
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=8651
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=8651 preview='‚úÖ TABLE: "FILO" | VAR: "med_50_59" | DESC: "Revenu m√©dian annuel disponible (‚Ç¨) - M√©nages dont le r√©f√©rent fiscal a de 50 √† 59 ans en 2021"\n‚úÖ TABLE: "FILO" | VAR: "MED_75+" | DESC: "Revenu m√©dian an
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=10 parent_clause='' sys_prompt_len=12070
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."med21" AS DOUBLE) AS "Revenu_median_annuel_disponible_2021_euros"\nFROM territoires t\nLEFT JOIN "FILO" f\n  ON t."ID" = f."ID"\nWHERE (t."ID" IN (\'
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(f."med21" AS DOUBLE) AS "revenu_median_annuel_disponible_2021_euros"\nFROM territoires t\nLEFT JOIN "FILO" f\n  ON t."ID" = f."ID"\nWHERE (t."ID" IN (\' ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] ids_count=10
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=10 cols=['ID', 'NOM_COUV', 'revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'revenu_median_annuel_disponible_2021_euros': 24270.0}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'revenu_median_annuel_disponible_2021_euros': 25210.0}, {'
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Peux-tu comparer le revenu moyen (ou m√©dian) des habitants de Vincennes (Val-de-Marne) avec celui des communes voisines (par exemple Saint-Mand√©, Montreuil, Fon' df_rows=10 df_cols=3
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='2"\n‚úÖ TABLE: "DIPL" | VAR: "11-14_COMRES" | DESC: "Population des 11 √† 14 ans scolaris√©s dans la commune de r√©sidence en 2022"\n‚úÖ TABLE: "SUP" | VAR: "POPap" | DESC: "Population compt√©e √† part en 202
[TERRIBOT][DBG] chart.config.raw :: selected=['revenu_median_annuel_disponible_2021_euros'] formats_keys=['revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['revenu_median_annuel_disponible_2021_euros'] formats={'revenu_median_annuel_disponible_2021_euros': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian 2021', 'title': 'Revenu m√©dian annuel disponible (euros) en 2021'}}
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'revenu_median_annuel_disponible_2021_euros'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] selected_metrics=['revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'revenu_median_annuel_disponible_2021_euros'] formats={'revenu_median_annuel_disponible_2021_euros': {'kind': 'currency', 'decimals': 0, 'label': 'Revenu m√©dian 2021', 'title': 'Revenu m√©dian annuel disponible (euros) en 2021'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1135
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'revenu_median_annuel_disponible_2021_euros'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] selected_metrics=['revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Quel est le taux de ch√¥mage √† manosque ?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=3
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail='viron **15\u202f000 ‚Ç¨** entre **Saint-Mand√©** et **Montreuil**, ce qui traduit une forte h√©t√©rog√©n√©it√© sociale entre communes.\n\n**Piste pour aller plus loin :** souhaitez-vous un graphique qui mont current_geo_name='Vincennes'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le **taux de ch√¥mage √† Manosque** ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Vincennes'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "04112",\n  "reason": "Le terme recherch√© est un nom de ville sans mention d\'intercommunalit√© ; on s√©lectionne donc la commune. Parmi les candidats, ¬´ Manosque ¬ª correspond √† la 
[TERRIBOT][DBG] pipeline.geo.after :: new_context=None
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quel est le **taux de ch√¥mage √† Manosque** ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quel est le **taux de ch√¥mage √† Manosque** ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quel est le **taux de ch√¥mage √† Manosque** ?' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5205823900319342
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=414
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=6857
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=6857 preview='‚úÖ TABLE: "DEFM_AN" | VAR: "defm2009" | DESC: "Nombre de DEFM en 2009"\n‚úÖ TABLE: "DEFM_AN" | VAR: "defm2010" | DESC: "Nombre de DEFM en 2010"\n‚úÖ TABLE: "DEFM_AN" | VAR: "defm2011" | DESC: "Nombre de D
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=10 parent_clause='' sys_prompt_len=10040
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1564" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_chom1564" AS DOUBLE) + TRY_CAST(a."p22_actocc2554" AS DOUBLE), 0) AS "taux_chomage"\nFROM territoir
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1564" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_h1564" AS DOUBLE) + TRY_CAST(a."p22_fchom1564" AS DOUBLE), 0) AS "taux_chomage"\nFROM territoires t ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] ids_count=10
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=10 cols=['ID', 'NOM_COUV', 'taux_chomage']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D94', 'NOM_COUV': 'Val-de-Marne', 'taux_chomage': 0.1656280349394286}, {'ID': 'R11', 'NOM_COUV': '√éle-de-France', 'taux_chomage': 0.16182740503153886}, {'ID': 'FR', 'NOM_COUV': 'France m√©trop
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quel est le **taux de ch√¥mage √† Manosque** ?' df_rows=10 df_cols=3
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['taux_chomage']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='opulation des inactifs de 15 √† 64 ans en 2016"\n‚úÖ TABLE: "ACT_10" | VAR: "p11_f1524" | DESC: "Femmes de 15 √† 24 ans en 2011"\n‚úÖ TABLE: "ACT_5" | VAR: "p16_f2554" | DESC: "Femmes de 25 √† 54 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['taux_chomage'] formats_keys=['taux_chomage']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['taux_chomage'] formats={'taux_chomage': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage', 'title': 'Taux de ch√¥mage'}}
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'taux_chomage'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] selected_metrics=['taux_chomage']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'taux_chomage'] formats={'taux_chomage': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage', 'title': 'Taux de ch√¥mage'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=1293
[TERRIBOT][PIPE] ‚úÖ Pipeline done
[TERRIBOT] ‚úÖ Script import√© / d√©marrage du fichier
[TERRIBOT] üìù D√©marrage de l'enregistrement des logs
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'revenu_median_annuel_disponible_2021_euros'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] selected_metrics=['revenu_median_annuel_disponible_2021_euros']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=False is_multi_metric=False y_format=',.0f'
[TERRIBOT][DBG] plot.enter :: df_rows=10 df_cols=['ID', 'NOM_COUV', 'taux_chomage'] sorted_ids=['94080', '200057941', 'D94', 'R11', '94067', '93048', '94033', '94052', '94018', 'FR'] selected_metrics=['taux_chomage']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=10 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT] ===============================
[TERRIBOT][DBG] pipeline.start :: prompt_to_process='Quel est le taux de ch√¥mage √† Manosque ?' from_trigger=False
[TERRIBOT][DBG] session.state :: has_geo=True ambiguity=False messages=5
[TERRIBOT][DBG] pipeline.rewrite.call :: history_tail=' ciblage des politiques d‚Äôacc√®s √† l‚Äôemploi (publics √©loign√©s de l‚Äôemploi, quartiers prioritaires, qualification, mobilit√©‚Ä¶).\n\n### Pour aller plus loin\nSouhaitez-vous un graphique qui montre **l‚Äô√©c current_geo_name='Vincennes'
[TERRIBOT][DBG] pipeline.rewrite.done :: rewritten_prompt='Quel est le **taux de ch√¥mage √† Manosque (Alpes-de-Haute-Provence)** ?'
[TERRIBOT][DBG] pipeline.geo.before :: force_geo_context=False current_geo='Vincennes'
[TERRIBOT][PIPE] üåç analyze_territorial_scope() running
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Manosque' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=11 sample=[{'ID': '4112', 'NOM_COUV': 'Manosque', 'COMP1': '200034700', 'COMP2': 'D4', 'COMP3': 'R93', 'TYPE_TERRITOIRE': 'Commune', 'score': 1.3}, {'ID': '28232', 'NOM_COUV': 'Manou', 'COMP1': '200070167', 'CO
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Manosque' candidates_len=11
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "4112",\n  "reason": "Le contexte pr√©cise ¬´ Manosque (Alpes-de-Haute-Provence) ¬ª : il s‚Äôagit de la commune de Manosque (d√©partement 04), correspondant au candidat ID 4112.",\n  "i
[TERRIBOT][DBG] geo.broad_candidates.enter :: input_str='Alpes-de-Haute-Provence' limit=15
[TERRIBOT][DBG] geo.broad_candidates.sql :: sql_preview="\n    WITH candidates AS (\n        SELECT \n            ID, \n            NOM_COUV, \n            COMP1, COMP2, COMP3,\n            CASE \n                WHEN length(ID) IN (4,5) THEN 'Commune'\n  
[TERRIBOT][DBG] geo.broad_candidates.result :: rows=1 sample=[{'ID': 'D4', 'NOM_COUV': 'Alpes de Haute-Provence', 'COMP1': None, 'COMP2': None, 'COMP3': None, 'TYPE_TERRITOIRE': 'D√©partement', 'score': 1.132608695652174}]
[TERRIBOT][DBG] geo.ai_validate.enter :: user_query='Alpes-de-Haute-Provence' candidates_len=1
[TERRIBOT][DBG] geo.ai_validate.exit :: raw='{\n  "selected_id": "D4",\n  "reason": "Le terme recherch√© ¬´ Alpes-de-Haute-Provence ¬ª correspond au nom d‚Äôun d√©partement ; le seul candidat propos√© est le d√©partement Alpes-de-Haute-Provence (ID D4)
[TERRIBOT][DBG] pipeline.geo.after :: new_context={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque, Alpes-de-Haute-Provence', 'debug_search': [{'Re
[TERRIBOT][DBG] pipeline.geo.context_set :: geo={'target_name': 'Manosque', 'target_id': '4112', 'all_ids': ['4112', '200034700', 'D4', 'R93', 'FR'], 'parent_clause': '', 'display_context': 'Manosque, Alpes-de-Haute-Provence', 'debug_search': [{'Re
[TERRIBOT][PIPE] üìö RAG hybrid_variable_search() start
[TERRIBOT][DBG] pipeline.rag.inputs :: rewritten_prompt='Quel est le **taux de ch√¥mage √† Manosque (Alpes-de-Haute-Provence)** ?' df_glossaire_rows=2043
[TERRIBOT][DBG] rag.hybrid.enter :: query='Quel est le **taux de ch√¥mage √† Manosque (Alpes-de-Haute-Provence)** ?' top_k=80
[TERRIBOT][DBG] rag.semantic.enter :: query='Quel est le **taux de ch√¥mage √† Manosque (Alpes-de-Haute-Provence)** ?' top_k=80 threshold=0.35 emb_shape=(2043, 1536) valid_indices_len=2043
[TERRIBOT][DBG] rag.semantic.sim :: similarities_len=2043 sim_max=0.5119607618827621
[TERRIBOT][DBG] rag.semantic.after_threshold :: kept_rows=376
[TERRIBOT][DBG] rag.semantic.return :: final_rows=80
[TERRIBOT][DBG] rag.hybrid.semantic :: sem_rows=80
[TERRIBOT][DBG] rag.hybrid.context :: context_len=6927
[TERRIBOT][DBG] pipeline.rag.done :: glossaire_context_len=6927 preview='‚úÖ TABLE: "DEFM_AN" | VAR: "defm2009" | DESC: "Nombre de DEFM en 2009"\n‚úÖ TABLE: "DEFM_AN" | VAR: "defm2011" | DESC: "Nombre de DEFM en 2011"\n‚úÖ TABLE: "DEFM_AN" | VAR: "defm2010" | DESC: "Nombre de D
[TERRIBOT][DBG] pipeline.sql.gen.call :: ids_count=5 parent_clause='' sys_prompt_len=10089
[TERRIBOT][DBG] pipeline.sql.gen.raw :: sql_query='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1564" AS DOUBLE) / NULLIF(TRY_CAST(a."p11_chom1564" AS DOUBLE) + TRY_CAST(a."p11_actocc1564" AS DOUBLE), 0) AS "taux_chomage_15_64"\nFROM ter
[TERRIBOT][DBG] sql.fix.enter :: max_retries=3
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 0/3
[TERRIBOT][SQL] ‚ùå DuckDB error: Binder Error: Values list "a" does not have a column named "p11_inact1564"
[TERRIBOT][SQL] üïµÔ∏è Alias r√©solu : 'a' -> 'ACT'
[TERRIBOT][SQL] üõ†Ô∏è Asking model to fix SQL with Schema Hint
[TERRIBOT][SQL] ‚ñ∂Ô∏è attempt 1/3
[TERRIBOT][SQL] ‚úÖ EXPLAIN OK
[TERRIBOT][DBG] sql.exec.about_to_run :: sql='SELECT\n  t."ID",\n  t."NOM_COUV",\n  TRY_CAST(a."p22_chom1564" AS DOUBLE) / NULLIF(TRY_CAST(a."p22_act1564" AS DOUBLE), 0) AS "taux_chomage"\nFROM territoires t\nLEFT JOIN "ACT" a\n  ON t."ID" = a." ids=['4112', '200034700', 'D4', 'R93', 'FR'] ids_count=5
[TERRIBOT][DBG] sql.exec.result :: empty=False rows=5 cols=['ID', 'NOM_COUV', 'taux_chomage']
[TERRIBOT][DBG] sql.exec.head :: head=[{'ID': 'D4', 'NOM_COUV': 'Alpes de Haute-Provence', 'taux_chomage': 0.11772323809832115}, {'ID': 'R93', 'NOM_COUV': 'PACA', 'taux_chomage': 0.11993184147192787}, {'ID': 'FR', 'NOM_COUV': 'France m√©tr
[TERRIBOT][PIPE] üìà get_chart_configuration() start
[TERRIBOT][DBG] chart.config.enter :: question='Quel est le **taux de ch√¥mage √† Manosque (Alpes-de-Haute-Provence)** ?' df_rows=5 df_cols=3
[TERRIBOT][DBG] chart.numeric_cols :: count=1 sample=['taux_chomage']
[TERRIBOT][DBG] chart.config.payload :: payload_keys=['question', 'available_columns', 'data_stats', 'glossaire_sample'] glossaire_tail='ESC: "Actifs de 25-54 ans en 2011"\n‚úÖ TABLE: "ACT_10" | VAR: "p11_f2554" | DESC: "Femmes de 25 √† 54 ans en 2011"\n‚úÖ TABLE: "ACT_10" | VAR: "p11_actocc1564" | DESC: "Actifs occup√©s de 15-64 ans en 201
[TERRIBOT][DBG] chart.config.raw :: selected=['taux_chomage'] formats_keys=['taux_chomage']
[TERRIBOT][DBG] pipeline.chart_config.done :: selected=['taux_chomage'] formats={'taux_chomage': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage', 'title': 'Taux de ch√¥mage'}}
[TERRIBOT][DBG] plot.enter :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'taux_chomage'] sorted_ids=['4112', '200034700', 'D4', 'R93', 'FR'] selected_metrics=['taux_chomage']
[TERRIBOT][DBG] plot.detect_cols :: label_col='NOM_COUV' date_col=None id_col='ID'
[TERRIBOT][DBG] plot.sort :: status='success' col='POP_MOCO_40'
[TERRIBOT][DBG] plot.vega :: melted_rows=5 is_percent=True is_multi_metric=False y_format='.1%'
[TERRIBOT][PIPE] üìù Streaming response start
[TERRIBOT][DBG] pipeline.stream.inputs :: df_rows=5 df_cols=['ID', 'NOM_COUV', 'taux_chomage'] formats={'taux_chomage': {'kind': 'percent', 'decimals': 1, 'label': 'Ch√¥mage', 'title': 'Taux de ch√¥mage'}}
[TERRIBOT][DBG] pipeline.stream.done :: response_len=731
[TERRIBOT][PIPE] ‚úÖ Pipeline done
  Stopping...
